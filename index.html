<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>2026ë…„ ë³´ë™ë³´ë™ ê°“ìƒì§€ì›ê¸ˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Gmarket+Sans:wght@300;500;700&display=swap" rel="stylesheet">

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS VARIABLES â€” BLUE THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --primary: #1A56DB;
  --primary-light: #3F83F8;
  --primary-dark: #1e3a8a;
  --primary-darker: #172554;
  --accent: #F59E0B;
  --accent2: #FCD34D;
  --kakao: #FEE500;
  --kakao-text: #191919;
  --bg: #EFF6FF;
  --surface: #FFFFFF;
  --surface2: #F0F7FF;
  --text: #1E3A5F;
  --text-muted: #64748B;
  --border: #BFDBFE;
  --border-strong: #93C5FD;
  --danger: #EF4444;
  --success: #10B981;
  --warning: #F59E0B;
  --info: #3B82F6;
  --shadow: 0 4px 20px rgba(26,86,219,0.10);
  --radius: 16px;
  --radius-sm: 10px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
* { box-sizing: border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
html { scroll-behavior: smooth; }
body {
  font-family: 'Noto Sans KR', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 15px;
  line-height: 1.5;
  /* â˜… ì•± ì „ì²´ë¥¼ ì²˜ìŒì—” ìˆ¨ê¹€ â€” JSê°€ ì¤€ë¹„ë˜ë©´ ë³´ì—¬ì¤Œ */
  visibility: hidden;
}
body.ready { visibility: visible; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loading-screen {
  position: fixed; inset: 0; z-index: 9999;
  background: linear-gradient(160deg, var(--primary-darker) 0%, var(--primary-dark) 60%, #1e40af 100%);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.4s;
}
#loading-screen.hidden { opacity: 0; pointer-events: none; }
.loading-dice { font-size: 4rem; animation: bounce 1s infinite; }
@keyframes bounce { 0%,100%{ transform:translateY(0); } 50%{ transform:translateY(-12px); } }
.loading-title { font-family:'Gmarket Sans',sans-serif; font-size:1.6rem; color:var(--accent2); font-weight:700; margin:12px 0 4px; }
.loading-sub { color:#93C5FD; font-size:0.9rem; margin-bottom:28px; }
.spinner { width:36px; height:36px; border:3px solid rgba(255,255,255,0.2); border-top-color:var(--accent2); border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#login-page {
  display: none; position: fixed; inset: 0; z-index: 200;
  background: linear-gradient(160deg, var(--primary-darker) 0%, var(--primary-dark) 55%, #1d4ed8 100%);
  overflow-y: auto;
}
.login-container {
  min-height: 100vh; display:flex; flex-direction:column; align-items:center;
  justify-content:center; padding:24px 20px;
}
.login-hero { text-align:center; margin-bottom:32px; }
.login-emoji { font-size:4rem; display:block; margin-bottom:12px; filter:drop-shadow(0 4px 12px rgba(0,0,0,0.3)); }
.login-title { font-family:'Gmarket Sans',sans-serif; font-size:1.7rem; color:#FCD34D; font-weight:700; line-height:1.3; margin-bottom:8px; }
.login-subtitle { color:#93C5FD; font-size:0.9rem; }
.login-card {
  background:#fff; border-radius:24px; padding:28px 24px; width:100%; max-width:400px;
  box-shadow:0 24px 64px rgba(0,0,0,0.4);
}
.login-tab-row { display:flex; gap:0; margin-bottom:20px; background:var(--bg); border-radius:10px; padding:3px; }
.login-tab {
  flex:1; text-align:center; padding:9px 6px; border-radius:8px; cursor:pointer;
  font-size:0.85rem; font-weight:500; color:var(--text-muted); transition:all 0.2s;
  border:none; background:transparent; font-family:inherit;
}
.login-tab.active { background:#fff; color:var(--primary); box-shadow:0 2px 8px rgba(0,0,0,0.1); font-weight:700; }
.login-panel { display:none; }
.login-panel.active { display:block; }

/* Float-label inputs */
.fl-input { position:relative; margin-bottom:14px; }
.fl-input input {
  width:100%; border:1.5px solid var(--border); border-radius:10px;
  padding:20px 14px 8px; font-family:inherit; font-size:0.95rem;
  background:var(--surface2); color:var(--text); outline:none; transition:border-color 0.2s;
}
.fl-input input:focus { border-color:var(--primary-light); background:#fff; }
.fl-input label {
  position:absolute; left:14px; top:50%; transform:translateY(-50%);
  font-size:0.9rem; color:var(--text-muted); pointer-events:none; transition:all 0.15s;
}
.fl-input input:focus ~ label,
.fl-input input:not(:placeholder-shown) ~ label {
  top:10px; transform:none; font-size:0.7rem; color:var(--primary); font-weight:600;
}
.form-divider { display:flex; align-items:center; gap:10px; margin:16px 0; }
.form-divider::before,.form-divider::after { content:''; flex:1; height:1px; background:var(--border); }
.form-divider span { font-size:0.8rem; color:var(--text-muted); white-space:nowrap; }

/* Kakao button */
.btn-kakao {
  width:100%; padding:14px 16px; border:none; border-radius:12px;
  background:var(--kakao); color:var(--kakao-text);
  font-family:inherit; font-size:1rem; font-weight:700;
  display:flex; align-items:center; justify-content:center; gap:10px;
  cursor:pointer; transition:all 0.2s; margin-bottom:10px; letter-spacing:-0.2px;
}
.btn-kakao:hover { background:#e6cf00; transform:translateY(-1px); }
.btn-kakao:active { transform:scale(0.97); }
.kakao-icon { width:22px; height:22px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app { display:none; min-height:100vh; flex-direction:column; }
#app.show { display:flex; }

.app-header {
  background:linear-gradient(135deg,var(--primary-darker) 0%,var(--primary-dark) 100%);
  padding:0 16px; height:56px; display:flex; align-items:center;
  justify-content:space-between; position:sticky; top:0; z-index:100;
  box-shadow:0 2px 12px rgba(0,0,0,0.25);
}
.app-header-logo { font-family:'Gmarket Sans',sans-serif; font-size:0.95rem; color:#FCD34D; font-weight:700; cursor:pointer; line-height:1.2; }
.app-header-logo small { display:block; color:#93C5FD; font-size:0.68rem; font-weight:300; }
.header-user { display:flex; align-items:center; gap:8px; }
.header-chip { background:rgba(255,255,255,0.12); border-radius:20px; padding:5px 12px; font-size:0.82rem; color:#E0F2FE; display:flex; align-items:center; gap:6px; }
.credit-pill { background:var(--accent); color:#fff; border-radius:10px; padding:2px 9px; font-size:0.76rem; font-weight:700; }
.btn-icon { background:rgba(255,255,255,0.12); border:none; color:#fff; border-radius:8px; padding:7px 10px; cursor:pointer; font-size:1rem; }

.bottom-nav {
  position:fixed; bottom:0; left:0; right:0; z-index:100;
  background:var(--primary-darker); border-top:1px solid rgba(255,255,255,0.1);
  display:flex; padding-bottom:env(safe-area-inset-bottom);
  box-shadow:0 -4px 20px rgba(0,0,0,0.3);
}
.bottom-nav-item {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:8px 4px; cursor:pointer; border:none; background:none;
  color:#64748B; font-family:inherit; font-size:0.65rem; gap:3px;
  transition:all 0.2s; border-top:2px solid transparent;
}
.bottom-nav-item .nav-icon { font-size:1.3rem; line-height:1; }
.bottom-nav-item.active { color:var(--accent2); border-top-color:var(--accent2); }

.app-body { flex:1; overflow-y:auto; padding:16px 16px 80px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page { display:none; }
.page.active { display:block; animation:fadeUp 0.25s ease; }
@keyframes fadeUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPONENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-header { margin-bottom:16px; }
.page-title { font-family:'Gmarket Sans',sans-serif; font-size:1.25rem; font-weight:700; color:var(--primary-dark); }
.page-sub { font-size:0.82rem; color:var(--text-muted); margin-top:2px; }

.card { background:var(--surface); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-bottom:14px; border:1px solid var(--border); }
.card-title { font-size:0.95rem; font-weight:700; color:var(--primary-dark); margin-bottom:12px; display:flex; align-items:center; gap:6px; }

.stats-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:14px; }
.stat-card { background:var(--surface); border-radius:var(--radius-sm); padding:14px 12px; border:1px solid var(--border); box-shadow:var(--shadow); }
.stat-label { font-size:0.72rem; color:var(--text-muted); margin-bottom:4px; }
.stat-value { font-size:1.3rem; font-weight:700; font-family:'Gmarket Sans',sans-serif; color:var(--primary-dark); }
.stat-value.accent { color:var(--accent); }
.stat-value.blue { color:var(--primary); }
.stat-value.green { color:var(--success); }
.stat-value.warn { color:var(--warning); }

.btn {
  display:inline-flex; align-items:center; justify-content:center; gap:6px;
  border:none; border-radius:var(--radius-sm); padding:12px 20px;
  font-family:inherit; font-size:0.9rem; font-weight:600; cursor:pointer;
  transition:all 0.18s; white-space:nowrap; letter-spacing:-0.2px;
}
.btn:active { transform:scale(0.97); }
.btn-primary { background:var(--primary); color:#fff; }
.btn-primary:hover { background:var(--primary-dark); }
.btn-accent { background:var(--accent); color:#fff; }
.btn-outline { background:transparent; border:1.5px solid var(--border-strong); color:var(--primary); }
.btn-danger { background:var(--danger); color:#fff; }
.btn-success { background:var(--success); color:#fff; }
.btn-warn { background:var(--warning); color:#fff; }
.btn-info { background:var(--info); color:#fff; }
.btn-ghost { background:transparent; color:var(--text-muted); border:1px solid var(--border); }
.btn-sm { padding:7px 14px; font-size:0.82rem; border-radius:8px; }
.btn-xs { padding:4px 10px; font-size:0.76rem; border-radius:6px; font-weight:500; }
.btn-full { width:100%; }
.btn-row { display:flex; gap:8px; flex-wrap:wrap; }

.form-group { margin-bottom:14px; }
.form-label { display:block; font-size:0.82rem; font-weight:600; color:var(--text-muted); margin-bottom:6px; }
.form-label .req { color:var(--danger); margin-left:2px; }
.form-input, .form-select, .form-textarea {
  width:100%; border:1.5px solid var(--border); border-radius:var(--radius-sm);
  padding:11px 13px; font-family:inherit; font-size:0.92rem;
  background:var(--surface2); color:var(--text); outline:none;
  transition:border-color 0.2s, box-shadow 0.2s; -webkit-appearance:none;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  border-color:var(--primary-light); background:#fff;
  box-shadow:0 0 0 3px rgba(59,130,246,0.1);
}
.form-textarea { resize:vertical; min-height:72px; }
.form-row-2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.form-hint { font-size:0.76rem; color:var(--text-muted); margin-top:4px; }

.badge { display:inline-flex; align-items:center; padding:3px 9px; border-radius:12px; font-size:0.74rem; font-weight:700; white-space:nowrap; }
.badge-pending { background:#FEF3C7; color:#92400E; }
.badge-approved { background:#D1FAE5; color:#065F46; }
.badge-rejected { background:#FEE2E2; color:#991B1B; }
.badge-cancelled { background:#F1F5F9; color:#475569; }
.badge-mod-approved { background:#DBEAFE; color:#1E40AF; }

.credit-bar-bg { background:var(--border); border-radius:4px; height:8px; overflow:hidden; margin-top:4px; }
.credit-bar-fill { height:100%; border-radius:4px; background:linear-gradient(90deg,var(--primary-light),var(--primary)); transition:width 0.4s; }
.section-divider { border:none; border-top:1px solid var(--border); margin:16px 0; }

.pill-select-row { display:flex; gap:6px; flex-wrap:wrap; }
.pill-opt { padding:7px 14px; border-radius:20px; border:1.5px solid var(--border); background:var(--surface2); color:var(--text-muted); font-size:0.83rem; cursor:pointer; font-family:inherit; font-weight:500; transition:all 0.15s; }
.pill-opt.selected { border-color:var(--primary); background:var(--primary); color:#fff; }

.amount-display { background:linear-gradient(135deg,var(--primary-dark) 0%,var(--primary) 100%); border-radius:var(--radius-sm); padding:14px 16px; color:#fff; display:flex; justify-content:space-between; align-items:center; }
.amount-display .label { font-size:0.82rem; opacity:0.8; }
.amount-display .value { font-size:1.3rem; font-weight:700; font-family:'Gmarket Sans',sans-serif; }

.entry-card { background:var(--surface); border:1.5px solid var(--border-strong); border-radius:var(--radius); padding:16px; margin-bottom:12px; box-shadow:0 2px 12px rgba(26,86,219,0.07); }
.entry-card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
.entry-card-title { font-weight:700; color:var(--primary-dark); font-size:0.95rem; display:flex; align-items:center; gap:6px; }
.entry-num { background:var(--primary); color:#fff; width:24px; height:24px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; font-size:0.78rem; font-weight:700; }

.participant-block { background:var(--surface2); border-radius:var(--radius-sm); padding:12px; margin-bottom:8px; border:1px solid var(--border); }
.participant-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.participant-label { font-size:0.8rem; font-weight:700; color:var(--primary); }

.receipt-zone { border:2px dashed var(--border-strong); border-radius:var(--radius-sm); padding:20px 16px; text-align:center; cursor:pointer; transition:all 0.2s; background:var(--surface2); position:relative; }
.receipt-zone:hover { border-color:var(--primary); background:#EFF6FF; }
.receipt-zone.has-file { border-color:var(--success); border-style:solid; background:#F0FDF4; }
.receipt-zone img { max-width:100%; max-height:160px; border-radius:8px; margin-top:10px; object-fit:contain; }
.receipt-remove { position:absolute; top:8px; right:8px; background:var(--danger); color:#fff; border:none; border-radius:50%; width:28px; height:28px; cursor:pointer; font-size:0.9rem; display:flex; align-items:center; justify-content:center; z-index:2; }

.entry-total { background:linear-gradient(135deg,#EFF6FF,#DBEAFE); border-radius:8px; padding:10px 14px; display:flex; justify-content:space-between; align-items:center; margin-top:10px; border:1px solid var(--border-strong); }
.entry-total .et-label { font-size:0.82rem; color:var(--primary); font-weight:600; }
.entry-total .et-value { font-size:1.05rem; font-weight:700; color:var(--primary-dark); }

.floating-bar {
  position:fixed; bottom:56px; left:0; right:0; z-index:90;
  background:rgba(255,255,255,0.96); backdrop-filter:blur(10px);
  border-top:1px solid var(--border); padding:10px 16px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  box-shadow:0 -4px 20px rgba(26,86,219,0.12);
}
.floating-total { font-size:0.82rem; color:var(--text-muted); }
.floating-total strong { display:block; font-size:1.05rem; color:var(--primary-dark); }

.app-list-item { background:var(--surface); border-radius:var(--radius-sm); padding:14px; border:1px solid var(--border); margin-bottom:10px; cursor:pointer; transition:all 0.15s; box-shadow:var(--shadow); }
.app-list-item:active { transform:scale(0.98); }
.app-list-row { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px; }
.app-list-name { font-weight:700; font-size:0.92rem; color:var(--text); }
.app-list-date { font-size:0.78rem; color:var(--text-muted); }
.app-list-amount { font-size:1.05rem; font-weight:700; color:var(--primary-dark); font-family:'Gmarket Sans',sans-serif; }
.app-list-meta { font-size:0.78rem; color:var(--text-muted); }
.app-list-actions { display:flex; gap:6px; margin-top:8px; padding-top:8px; border-top:1px solid var(--border); flex-wrap:wrap; }

/* Toast */
#toast-container { position:fixed; top:70px; left:16px; right:16px; z-index:9999; display:flex; flex-direction:column; gap:8px; pointer-events:none; }
.toast { background:var(--primary-darker); color:#fff; border-radius:12px; padding:13px 18px; font-size:0.88rem; box-shadow:0 4px 20px rgba(0,0,0,0.3); animation:slideDown 0.3s ease; display:flex; align-items:center; gap:10px; pointer-events:auto; }
.toast.success { background:#065F46; }
.toast.error { background:#991B1B; }
.toast.warning { background:#92400E; }
@keyframes slideDown { from { opacity:0; transform:translateY(-12px); } to { opacity:1; transform:none; } }

/* Modal */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:500; align-items:flex-end; justify-content:center; backdrop-filter:blur(4px); }
.modal-overlay.open { display:flex; }
.modal-overlay.center { align-items:center; }
.modal { background:#fff; border-radius:24px 24px 0 0; padding:24px 20px; width:100%; max-height:90vh; overflow-y:auto; box-shadow:0 -8px 40px rgba(0,0,0,0.3); animation:slideUp 0.3s ease; }
.modal.center-modal { border-radius:24px; max-width:480px; width:calc(100% - 32px); animation:fadeInScale 0.25s; }
.modal.confirm-modal { border-radius:20px; max-width:340px; width:calc(100% - 32px); animation:fadeInScale 0.2s; padding:28px 24px; text-align:center; }
@keyframes slideUp { from { transform:translateY(40px); opacity:0; } to { transform:none; opacity:1; } }
@keyframes fadeInScale { from { opacity:0; transform:scale(0.94); } to { opacity:1; transform:none; } }
.modal-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:0 auto 18px; }
.modal-title { font-size:1.05rem; font-weight:700; color:var(--primary-dark); margin-bottom:16px; display:flex; align-items:center; gap:8px; }
.modal-actions { display:flex; gap:8px; margin-top:20px; }
.modal-actions .btn { flex:1; }

/* Confirm Dialog */
.confirm-icon { font-size:2.5rem; margin-bottom:12px; }
.confirm-title { font-size:1.05rem; font-weight:700; color:var(--text); margin-bottom:8px; }
.confirm-msg { font-size:0.88rem; color:var(--text-muted); margin-bottom:20px; line-height:1.5; }
.confirm-actions { display:flex; gap:8px; }
.confirm-actions .btn { flex:1; }

/* Pending dot */
.pending-dot { width:8px; height:8px; border-radius:50%; background:var(--accent); display:inline-block; animation:pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{ opacity:1; } 50%{ opacity:0.3; } }

.highlight { background:linear-gradient(135deg,rgba(59,130,246,0.08),rgba(147,197,253,0.1)); border:1px solid var(--border-strong); border-radius:var(--radius-sm); padding:12px 14px; }
.flex-between { display:flex; justify-content:space-between; align-items:center; }
.flex-center { display:flex; align-items:center; gap:8px; }
.text-muted { color:var(--text-muted); font-size:0.82rem; }
.mt-1 { margin-top:4px; } .mt-2 { margin-top:8px; } .mt-3 { margin-top:14px; }
.mb-2 { margin-bottom:8px; } .mb-3 { margin-bottom:14px; }
.empty-state { text-align:center; padding:40px 20px; color:var(--text-muted); }
.empty-icon { font-size:3rem; margin-bottom:10px; }

.detail-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:0.88rem; }
.detail-row:last-child { border-bottom:none; }
.detail-key { color:var(--text-muted); }
.detail-val { font-weight:600; text-align:right; flex:1; margin-left:12px; }

.admin-tag { background:rgba(255,215,0,0.2); border:1px solid rgba(255,215,0,0.5); color:#7C3AED; border-radius:4px; padding:2px 7px; font-size:0.72rem; font-weight:700; }
.filter-row { display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap; }
.filter-row .form-input, .filter-row .form-select { flex:1; min-width:120px; font-size:0.85rem; padding:9px 12px; }

/* Skeleton loader */
.skeleton { background:linear-gradient(90deg,#e8eef7 25%,#d0ddf0 50%,#e8eef7 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; border-radius:8px; }
@keyframes shimmer { 0%{ background-position:200% 0; } 100%{ background-position:-200% 0; } }
.sk-line { height:14px; margin-bottom:8px; }
.sk-card { height:80px; margin-bottom:10px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT â€” A4
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media print {
  * { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  body > *:not(#print-area) { display:none !important; }
  #print-area { display:block !important; position:static !important; }
}
#print-area { display:none; }
.print-page { width:210mm; min-height:297mm; margin:0 auto; padding:18mm 16mm 14mm; font-family:'Noto Sans KR',sans-serif; font-size:11pt; color:#000; background:#fff; display:flex; flex-direction:column; }
.print-header-bar { background:#1e3a8a; color:#fff; padding:10px 16px; border-radius:4px; margin-bottom:8px; }
.print-main-title { font-size:14pt; font-weight:900; }
.print-sub { font-size:9pt; opacity:0.85; margin-top:2px; }
.print-stamp-row { display:flex; justify-content:flex-end; margin-bottom:12px; }
.print-stamp { border:2px solid #1e3a8a; border-radius:4px; padding:6px 20px; font-size:9pt; text-align:center; }
.print-stamp .stamp-label { font-weight:700; color:#1e3a8a; }
.print-section { margin-bottom:14px; }
.print-section-title { font-size:10pt; font-weight:700; color:#1e3a8a; border-bottom:2px solid #1e3a8a; padding-bottom:4px; margin-bottom:8px; }
.print-table { width:100%; border-collapse:collapse; font-size:10pt; }
.print-table th { background:#1e3a8a; color:#fff; padding:7px 10px; text-align:left; font-weight:600; }
.print-table td { padding:7px 10px; border:1px solid #ccc; vertical-align:top; }
.print-table tr:nth-child(even) td { background:#F8F9FA; }
.print-total-box { border:2px solid #1e3a8a; border-radius:4px; padding:10px 16px; margin-bottom:14px; display:flex; justify-content:space-between; align-items:center; }
.print-total-label { font-size:11pt; font-weight:700; color:#1e3a8a; }
.print-total-amount { font-size:14pt; font-weight:900; color:#1e3a8a; }
.print-bank-box { border:1.5px solid #93C5FD; border-radius:4px; padding:12px 16px; background:#EFF6FF; }
.print-bank-row { display:flex; gap:8px; margin-bottom:5px; font-size:10pt; }
.print-bank-key { color:#1e40af; font-weight:700; min-width:70px; }
.print-footer { margin-top:auto; padding-top:12px; border-top:1px solid #ccc; display:flex; justify-content:space-between; font-size:8pt; color:#888; }
.print-sig { border:1px solid #ccc; border-radius:4px; padding:10px 20px; text-align:center; font-size:9pt; }
.print-sig-line { border-top:1px solid #999; width:80px; margin:18px auto 4px; }

@media (max-width:380px) { .form-row-2 { grid-template-columns:1fr; } }
@media (min-width:600px) {
  .app-body { max-width:600px; margin:0 auto; }
  .floating-bar { max-width:600px; left:50%; transform:translateX(-50%); }
  .bottom-nav { max-width:600px; left:50%; transform:translateX(-50%); }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loading-screen">
  <div class="loading-dice">ğŸ²</div>
  <div class="loading-title">ë³´ë™ë³´ë™ ê°“ìƒì§€ì›ê¸ˆ</div>
  <div class="loading-sub">2026ë…„ ë³´ë“œê²Œì„ ì§€ì›ê¸ˆ ì‹ ì²­ ì‹œìŠ¤í…œ</div>
  <div class="spinner"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-page">
  <div class="login-container">
    <div class="login-hero">
      <span class="login-emoji">ğŸ²</span>
      <div class="login-title">2026 ë³´ë™ë³´ë™<br>ê°“ìƒì§€ì›ê¸ˆ</div>
      <div class="login-subtitle">ë³´ë“œê²Œì„ Â· ë°©íƒˆì¶œ ì§€ì›ê¸ˆ ì‹ ì²­ í”Œë«í¼</div>
    </div>

    <div class="login-card">
      <div class="login-tab-row">
        <button class="login-tab active" onclick="switchTab('login')">ë¡œê·¸ì¸</button>
        <button class="login-tab" onclick="switchTab('signup')">íšŒì›ê°€ì…</button>
      </div>

      <!-- ë¡œê·¸ì¸ -->
      <div class="login-panel active" id="panel-login">
        <button class="btn-kakao" onclick="kakaoLogin()">
          <svg class="kakao-icon" viewBox="0 0 24 24" fill="none">
            <path d="M12 3C6.477 3 2 6.477 2 10.8c0 2.7 1.568 5.077 3.938 6.538L4.8 21l4.2-2.1c.96.18 1.97.27 3 .27 5.523 0 10-3.477 10-7.77C22 6.477 17.523 3 12 3z" fill="#191919"/>
          </svg>
          ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸
        </button>
        <div class="form-divider"><span>ë˜ëŠ” ì´ë©”ì¼ ë¡œê·¸ì¸</span></div>
        <div class="fl-input">
          <input type="email" id="login-email" placeholder=" " autocomplete="email">
          <label>ì´ë©”ì¼</label>
        </div>
        <div class="fl-input">
          <input type="password" id="login-pw" placeholder=" " autocomplete="current-password"
            onkeydown="if(event.key==='Enter')doEmailLogin()">
          <label>ë¹„ë°€ë²ˆí˜¸</label>
        </div>
        <button class="btn btn-primary btn-full" onclick="doEmailLogin()">ë¡œê·¸ì¸</button>
      </div>

      <!-- íšŒì›ê°€ì… -->
      <div class="login-panel" id="panel-signup">
        <div style="text-align:center;font-size:0.88rem;color:var(--text-muted);margin-bottom:16px;">
          SNS ê³„ì •ìœ¼ë¡œ ê°€ì… í›„ ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.
        </div>
        <button class="btn-kakao" onclick="kakaoLogin()">
          <svg class="kakao-icon" viewBox="0 0 24 24" fill="none">
            <path d="M12 3C6.477 3 2 6.477 2 10.8c0 2.7 1.568 5.077 3.938 6.538L4.8 21l4.2-2.1c.96.18 1.97.27 3 .27 5.523 0 10-3.477 10-7.77C22 6.477 17.523 3 12 3z" fill="#191919"/>
          </svg>
          ì¹´ì¹´ì˜¤ë¡œ ê°€ì…
        </button>
        <div class="form-divider"><span>ë˜ëŠ” ì´ë©”ì¼ë¡œ ì§ì ‘ ê°€ì…</span></div>
        <div class="fl-input">
          <input type="text" id="signup-name" placeholder=" ">
          <label>ì´ë¦„</label>
        </div>
        <div class="fl-input">
          <input type="email" id="signup-email" placeholder=" ">
          <label>ì´ë©”ì¼</label>
        </div>
        <div class="fl-input">
          <input type="password" id="signup-pw" placeholder=" ">
          <label>ë¹„ë°€ë²ˆí˜¸</label>
        </div>
        <button class="btn btn-primary btn-full" onclick="doEmailSignup()">ê°€ì… ì‹ ì²­</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">
  <header class="app-header">
    <div class="app-header-logo" onclick="goHome()">
      ğŸ² ë³´ë™ë³´ë™ ê°“ìƒì§€ì›ê¸ˆ
      <small>2026ë…„ ë³´ë“œê²Œì„ ì§€ì›ê¸ˆ</small>
    </div>
    <div class="header-user">
      <div class="header-chip">
        <span id="hdr-name">-</span>
        <span class="credit-pill" id="hdr-credit">â‚©0</span>
      </div>
      <button class="btn-icon" onclick="doLogout()">â†©</button>
    </div>
  </header>

  <div class="app-body">
    <!-- ëŒ€ì‹œë³´ë“œ -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div class="page-title" id="dash-greeting">ì•ˆë…•í•˜ì„¸ìš” ğŸ‘‹</div>
        <div class="page-sub">ì§€ì›ê¸ˆ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</div>
      </div>
      <div class="stats-grid" id="dash-stats"></div>
      <div class="card"><div class="card-title">ğŸ• ìµœê·¼ ì‹ ì²­</div><div id="dash-recent"></div></div>
      <button class="btn btn-accent btn-full" onclick="navigateTo('apply')">âœï¸ ì§€ì›ê¸ˆ ì‹ ì²­í•˜ê¸°</button>
    </div>

    <!-- ì‹ ì²­ -->
    <div class="page" id="page-apply">
      <div class="page-header">
        <div class="page-title">âœï¸ ì§€ì›ê¸ˆ ì‹ ì²­</div>
        <div class="page-sub">ì˜ìˆ˜ì¦ ì²¨ë¶€ í•„ìˆ˜ (ìµœëŒ€ 2MB)</div>
      </div>
      <div class="card" id="apply-credit-card"></div>
      <div id="app-entries"></div>
      <button class="btn btn-outline btn-full" onclick="addEntry()" style="margin-bottom:14px;">ï¼‹ ì‹ ì²­ í•­ëª© ì¶”ê°€</button>
      <div class="card">
        <div class="card-title">ğŸ¦ í™˜ê¸‰ ê³„ì¢Œ ì •ë³´</div>
        <div class="form-group">
          <label class="form-label">ì˜ˆê¸ˆì£¼<span class="req">*</span></label>
          <input class="form-input" type="text" id="apply-acname" placeholder="ì˜ˆê¸ˆì£¼ ì„±í•¨">
        </div>
        <div class="form-row-2">
          <div class="form-group">
            <label class="form-label">ì€í–‰ëª…<span class="req">*</span></label>
            <select class="form-select" id="apply-bank">
              <option value="">ì„ íƒ</option>
              <option>êµ­ë¯¼ì€í–‰</option><option>ì‹ í•œì€í–‰</option><option>ìš°ë¦¬ì€í–‰</option>
              <option>í•˜ë‚˜ì€í–‰</option><option>ë†í˜‘ì€í–‰</option><option>ê¸°ì—…ì€í–‰</option>
              <option>ì¹´ì¹´ì˜¤ë±…í¬</option><option>í† ìŠ¤ë±…í¬</option><option>ì¼€ì´ë±…í¬</option>
              <option>SCì œì¼ì€í–‰</option><option>ì”¨í‹°ì€í–‰</option><option>ê¸°íƒ€</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">ê³„ì¢Œë²ˆí˜¸<span class="req">*</span></label>
            <!-- ìˆ«ìë§Œ ì…ë ¥ -->
            <input class="form-input" type="text" id="apply-acnum" placeholder="ìˆ«ìë§Œ ì…ë ¥"
              inputmode="numeric" oninput="this.value=this.value.replace(/\D/g,'')">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ë¹„ê³ </label>
          <textarea class="form-textarea" id="apply-note" placeholder="ì „ë‹¬ì‚¬í•­ (ì„ íƒ)"></textarea>
        </div>
      </div>
      <div style="height:72px;"></div>
    </div>

    <!-- ë‚´ ì‹ ì²­ ë‚´ì—­ -->
    <div class="page" id="page-myapps">
      <div class="page-header flex-between">
        <div><div class="page-title">ğŸ“‹ ë‚´ ì‹ ì²­ ë‚´ì—­</div></div>
        <button class="btn btn-outline btn-sm" onclick="renderMyApps()">ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="myapps-list"></div>
    </div>

    <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
    <div class="page" id="page-admin">
      <div class="page-header flex-between">
        <div><div class="page-title">ğŸ›¡ï¸ ê´€ë¦¬ì</div><div class="page-sub">ì „ì²´ í˜„í™©</div></div>
        <span class="admin-tag">ADMIN</span>
      </div>
      <div class="stats-grid" id="admin-stats"></div>
      <div class="card">
        <div class="card-title flex-between">
          <span>â³ ìŠ¹ì¸ ëŒ€ê¸° <span class="pending-dot"></span></span>
          <button class="btn btn-outline btn-xs" onclick="navigateTo('admin-all')">ì „ì²´ë³´ê¸°</button>
        </div>
        <div id="admin-pending"></div>
      </div>
    </div>

    <!-- ê´€ë¦¬ì: ì „ì²´ ì‹ ì²­ -->
    <div class="page" id="page-admin-all">
      <div class="page-header"><div class="page-title">ğŸ“‚ ì „ì²´ ì‹ ì²­ ì·¨í•©</div></div>
      <div class="filter-row">
        <input class="form-input" type="search" id="admin-search" placeholder="ê²€ìƒ‰â€¦" oninput="renderAdminAll()">
        <select class="form-select" id="admin-sf" onchange="renderAdminAll()" style="min-width:110px;">
          <option value="">ì „ì²´</option>
          <option value="pending">ëŒ€ê¸°</option>
          <option value="approved">ìŠ¹ì¸</option>
          <option value="mod-approved">ìˆ˜ì •ìŠ¹ì¸</option>
          <option value="rejected">ë°˜ë ¤</option>
          <option value="cancelled">ì·¨ì†Œ</option>
        </select>
      </div>
      <div class="flex-between mb-2" style="gap:8px;">
        <div id="admin-all-count" class="text-muted"></div>
        <button class="btn btn-outline btn-sm" onclick="exportCSV()">ğŸ“¥ CSV</button>
      </div>
      <div id="admin-all-list"></div>
    </div>

    <!-- ê´€ë¦¬ì: íšŒì› -->
    <div class="page" id="page-admin-members">
      <div class="page-header flex-between">
        <div class="page-title">ğŸ‘¥ íšŒì› ê´€ë¦¬</div>
        <button class="btn btn-accent btn-sm" onclick="openCreateUserModal()">ï¼‹ ê³„ì • ìƒì„±</button>
      </div>
      <div id="admin-members-list"></div>
    </div>

    <!-- ê´€ë¦¬ì: ë¡œê·¸ -->
    <div class="page" id="page-admin-logs">
      <div class="page-header flex-between">
        <div class="page-title">ğŸ“œ ì‹œìŠ¤í…œ ë¡œê·¸</div>
        <button class="btn btn-ghost btn-sm" onclick="clearLogs()">ì´ˆê¸°í™”</button>
      </div>
      <div class="card" id="logs-content"></div>
    </div>
  </div>

  <nav class="bottom-nav" id="bottom-nav"></nav>

  <div class="floating-bar" id="floating-bar" style="display:none;">
    <div class="floating-total">ì´ ì‹ ì²­ê¸ˆì•¡<strong id="float-total">â‚©0</strong></div>
    <button class="btn btn-primary" onclick="submitApplication()" style="padding:11px 22px;">ğŸ“¨ ì‹ ì²­ ì œì¶œ</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- ì‹ ì²­ ìƒì„¸ -->
<div class="modal-overlay" id="modal-detail">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-detail-title">ì‹ ì²­ ìƒì„¸</div>
    <div id="modal-detail-body"></div>
    <div class="modal-actions" id="modal-detail-actions"></div>
  </div>
</div>

<!-- ê´€ë¦¬ì ìˆ˜ì • -->
<div class="modal-overlay center" id="modal-edit">
  <div class="modal center-modal">
    <div class="modal-title">âœï¸ ì‹ ì²­ ìˆ˜ì • (ê´€ë¦¬ì)</div>
    <div id="modal-edit-body"></div>
    <div class="modal-actions" id="modal-edit-actions"></div>
  </div>
</div>

<!-- ê³„ì • ìƒì„± -->
<div class="modal-overlay center" id="modal-create-user">
  <div class="modal center-modal">
    <div class="modal-title">â• ê³„ì • ìƒì„±</div>
    <div class="form-group"><label class="form-label">ì´ë¦„</label><input class="form-input" type="text" id="nu-name"></div>
    <div class="form-group"><label class="form-label">ì´ë©”ì¼</label><input class="form-input" type="email" id="nu-email"></div>
    <div class="form-group"><label class="form-label">ë¹„ë°€ë²ˆí˜¸</label><input class="form-input" type="password" id="nu-pw" value="4321"></div>
    <div class="form-group"><label class="form-label">ì´ˆê¸° í¬ë ˆë”§ (ì›)</label><input class="form-input" type="number" id="nu-credit" value="30000"></div>
    <div class="form-group"><label class="form-label">ì—­í• </label>
      <select class="form-select" id="nu-role"><option value="user">ì¼ë°˜ íšŒì›</option><option value="admin">ê´€ë¦¬ì</option></select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-create-user')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="createUser()">ìƒì„±</button>
    </div>
  </div>
</div>

<!-- í¬ë ˆë”§ ìˆ˜ì • -->
<div class="modal-overlay center" id="modal-credit">
  <div class="modal center-modal">
    <div class="modal-title">ğŸ’° í¬ë ˆë”§ ìˆ˜ì •</div>
    <div id="modal-credit-body"></div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-credit')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveCreditEdit()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸° -->
<div class="modal-overlay center" id="modal-print">
  <div class="modal center-modal" style="max-width:520px;">
    <div class="modal-title">ğŸ–¨ï¸ ì¸ì‡„ ë¯¸ë¦¬ë³´ê¸°</div>
    <div id="modal-print-preview" style="border:1px solid var(--border);border-radius:8px;padding:12px;background:#fafafa;max-height:60vh;overflow-y:auto;font-size:0.82rem;"></div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-print')">ë‹«ê¸°</button>
      <button class="btn btn-primary" onclick="doPrint()">ğŸ–¨ï¸ ì¸ì‡„</button>
    </div>
  </div>
</div>

<!-- â˜… í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ -->
<div class="modal-overlay center" id="modal-confirm">
  <div class="modal confirm-modal">
    <div class="confirm-icon" id="confirm-icon">âš ï¸</div>
    <div class="confirm-title" id="confirm-title">í™•ì¸</div>
    <div class="confirm-msg" id="confirm-msg"></div>
    <div class="confirm-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-confirm')">ì·¨ì†Œ</button>
      <button class="btn btn-danger" id="confirm-ok-btn" onclick="">í™•ì¸</button>
    </div>
  </div>
</div>

<div id="print-area"></div>
<div id="toast-container"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG â€” Supabase
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SUPABASE_URL  = 'https://vkznarlbevlyqnspmnlj.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrem5hcmxiZXZseXFuc3BtbmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2OTg5MTcsImV4cCI6MjA4NzI3NDkxN30.Gm_GJJoiWJU4fvtfUhK4Ci-8CP3dJjW1KWzSazhKoJA';

/* â˜… ì¹´ì¹´ì˜¤ REST API í‚¤ â€” ë°œê¸‰ë°›ì€ í‚¤ë¡œ êµì²´ */
const KAKAO_REST_API_KEY = '2417c77943305f9baf157dac61d6c7e6';
/* â˜… ì¹´ì¹´ì˜¤ ë¦¬ë‹¤ì´ë ‰íŠ¸ URI â€” ë°°í¬ URLë¡œ êµì²´
   ì˜ˆ: https://your-project.vercel.app/ ë˜ëŠ” http://localhost:3000 */
const KAKAO_REDIRECT_URI = 'https://bdbd-hp.vercel.app/';

const MAX_FILE_BYTES = 2 * 1024 * 1024; // 2MB

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUPABASE INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let ME = null;          // current user profile (from profiles table)
let entries = [];       // ì‹ ì²­ entry array
let editId   = '';
let printAppId = '';
let editCreditUid = '';
let currentPage = '';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('DOMContentLoaded', async () => {
  // Kakao redirect callback ì²˜ë¦¬
  const urlParams = new URLSearchParams(window.location.search);
  const kakaoCode = urlParams.get('code');

  if (kakaoCode) {
    await handleKakaoCallback(kakaoCode);
    // URL í´ë¦°ì—…
    window.history.replaceState({}, '', window.location.pathname);
  }

  // Supabase ì„¸ì…˜ í™•ì¸
  const { data: { session } } = await sb.auth.getSession();
  if (session) {
    await loadProfile(session.user);
  }

  // ë¡œë”© ì™„ë£Œ â†’ body í‘œì‹œ
  document.body.classList.add('ready');
  await fadeOutLoading();

  if (ME) {
    showApp();
  } else {
    showLogin();
  }

  // ì„¸ì…˜ ë³€ê²½ ê°ì§€
  sb.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session) {
      await loadProfile(session.user);
      if (ME) { showApp(); }
    } else if (event === 'SIGNED_OUT') {
      ME = null; showLogin();
    }
  });
});

async function fadeOutLoading() {
  return new Promise(resolve => {
    const ls = document.getElementById('loading-screen');
    ls.classList.add('hidden');
    setTimeout(() => { ls.style.display = 'none'; resolve(); }, 450);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILE LOAD / CREATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadProfile(authUser) {
  const { data, error } = await sb
    .from('profiles')
    .select('*')
    .eq('id', authUser.id)
    .single();

  if (error && error.code === 'PGRST116') {
    // Profile doesn't exist â€” create it
    const name = authUser.user_metadata?.full_name
               || authUser.user_metadata?.name
               || authUser.email?.split('@')[0]
               || 'ì‹ ê·œíšŒì›';
    const { data: newP, error: insertErr } = await sb.from('profiles').insert({
      id: authUser.id,
      email: authUser.email || '',
      name,
      role: 'user',
      status: 'pending',
      provider: authUser.app_metadata?.provider || 'email',
      credit_total: 0,
      credit_used: 0,
      credit_pending: 0,
    }).select().single();
    if (!insertErr) {
      ME = newP;
      addLog(`ì‹ ê·œ ê°€ì…: ${name} (${authUser.email})`);
    }
  } else if (data) {
    ME = data;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH â€” KAKAO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function kakaoLogin() {
  const url = `https://kauth.kakao.com/oauth/authorize`
    + `?client_id=${KAKAO_REST_API_KEY}`
    + `&redirect_uri=${encodeURIComponent(KAKAO_REDIRECT_URI)}`
    + `&response_type=code`;
  window.location.href = url;
}

async function handleKakaoCallback(code) {
  // ì¹´ì¹´ì˜¤ access token êµí™˜ì€ ì„œë²„ì‚¬ì´ë“œì—ì„œ í•´ì•¼ ì•ˆì „í•©ë‹ˆë‹¤.
  // ì—¬ê¸°ì„œëŠ” Supabase Edge Functionì„ í†µí•´ ì²˜ë¦¬í•˜ê±°ë‚˜,
  // ì§ì ‘ Supabase OAuthë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
  // ì•„ë˜ëŠ” Supabase OAuth ë°©ì‹ (Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ì¹´ì¹´ì˜¤ Provider ì„¤ì • í•„ìš”)
  toast('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...', '');
  // Supabaseê°€ ì¹´ì¹´ì˜¤ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¥¼ ì²˜ë¦¬ â€” onAuthStateChangeì—ì„œ ì¡í˜
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH â€” EMAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function doEmailLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pw    = document.getElementById('login-pw').value;
  if (!email || !pw) { toast('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

  const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
  if (error) { toast('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message, 'error'); return; }

  await loadProfile(data.user);
  if (!ME) { toast('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error'); return; }

  if (ME.status === 'pending')  { toast('ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤', 'warning'); await sb.auth.signOut(); ME = null; return; }
  if (ME.status === 'rejected') { toast('ê°€ì…ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤', 'error'); await sb.auth.signOut(); ME = null; return; }

  addLog(`ë¡œê·¸ì¸: ${ME.name}`, ME.id);
  showApp();
  toast(`ì–´ì„œì˜¤ì„¸ìš”, ${ME.name}ë‹˜! ğŸ²`, 'success');
}

async function doEmailSignup() {
  const name  = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const pw    = document.getElementById('signup-pw').value;
  if (!name || !email || !pw) { toast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

  const { data, error } = await sb.auth.signUp({
    email, password: pw,
    options: { data: { name } }
  });
  if (error) { toast('ê°€ì… ì‹¤íŒ¨: ' + error.message, 'error'); return; }

  // profileì€ onAuthStateChange â†’ loadProfileì—ì„œ ìƒì„±ë¨
  toast('ê°€ì… ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤ ğŸ™', 'warning');
}

async function doLogout() {
  if (ME) addLog(`ë¡œê·¸ì•„ì›ƒ: ${ME.name}`, ME.id);
  await sb.auth.signOut();
  ME = null; entries = [];
  showLogin();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHOW / HIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showLogin() {
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-page').style.display = 'block';
}
function showApp() {
  document.getElementById('login-page').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  initApp();
}
function switchTab(tab) {
  document.querySelectorAll('.login-tab').forEach((t,i)=>t.classList.toggle('active', (i===0&&tab==='login')||(i===1&&tab==='signup')));
  document.querySelectorAll('.login-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('panel-'+tab).classList.add('active');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initApp() {
  refreshHeader();
  buildNav();
  goHome();
}

function refreshHeader() {
  if (!ME) return;
  document.getElementById('hdr-name').textContent = ME.name;
  const avail = Math.max(0, ME.credit_total - ME.credit_used - ME.credit_pending);
  document.getElementById('hdr-credit').textContent = 'â‚©' + fmt(avail);
}

const USER_NAVS  = [{id:'dashboard',icon:'ğŸ ',label:'í™ˆ'},{id:'apply',icon:'âœï¸',label:'ì‹ ì²­'},{id:'myapps',icon:'ğŸ“‹',label:'ë‚´ì—­'}];
const ADMIN_NAVS = [{id:'admin',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},{id:'admin-all',icon:'ğŸ“‚',label:'ì‹ ì²­ëª©ë¡'},{id:'admin-members',icon:'ğŸ‘¥',label:'íšŒì›'},{id:'admin-logs',icon:'ğŸ“œ',label:'ë¡œê·¸'}];

function buildNav() {
  const navs = ME.role === 'admin' ? ADMIN_NAVS : USER_NAVS;
  document.getElementById('bottom-nav').innerHTML = navs.map(n=>
    `<button class="bottom-nav-item" id="nav-${n.id}" onclick="navigateTo('${n.id}')">
      <span class="nav-icon">${n.icon}</span><span>${n.label}</span>
    </button>`).join('');
}

function goHome() { navigateTo(ME?.role === 'admin' ? 'admin' : 'dashboard'); }

function navigateTo(page) {
  currentPage = page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bottom-nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+page)?.classList.add('active');
  document.getElementById('nav-'+page)?.classList.add('active');
  document.getElementById('floating-bar').style.display = page==='apply' ? 'flex' : 'none';
  document.querySelector('.app-body').scrollTop = 0;
  switch(page) {
    case 'dashboard':      renderDashboard(); break;
    case 'apply':          initApply(); break;
    case 'myapps':         renderMyApps(); break;
    case 'admin':          renderAdminDash(); break;
    case 'admin-all':      renderAdminAll(); break;
    case 'admin-members':  renderAdminMembers(); break;
    case 'admin-logs':     renderLogs(); break;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderDashboard() {
  // Refresh ME
  const { data } = await sb.from('profiles').select('*').eq('id', ME.id).single();
  if (data) { ME = data; refreshHeader(); }

  const avail = Math.max(0, ME.credit_total - ME.credit_used - ME.credit_pending);
  const pct   = ME.credit_total > 0 ? Math.min(100, (ME.credit_used + ME.credit_pending) / ME.credit_total * 100) : 0;
  const hour  = new Date().getHours();
  const gr    = hour < 12 ? 'ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”' : hour < 17 ? 'ì•ˆë…•í•˜ì„¸ìš”' : 'ìˆ˜ê³ í•˜ì…¨ì–´ìš”';
  document.getElementById('dash-greeting').textContent = `${gr}, ${ME.name}ë‹˜ ğŸ‘‹`;
  document.getElementById('dash-stats').innerHTML = `
    <div class="stat-card"><div class="stat-label">ì´ ì§€ì› í¬ë ˆë”§</div><div class="stat-value blue">â‚©${fmt(ME.credit_total)}</div></div>
    <div class="stat-card">
      <div class="stat-label">ì‚¬ìš© ê°€ëŠ¥</div>
      <div class="stat-value accent">â‚©${fmt(avail)}</div>
      <div class="credit-bar-bg"><div class="credit-bar-fill" style="width:${pct}%"></div></div>
    </div>
    <div class="stat-card"><div class="stat-label">ìŠ¹ì¸ ì™„ë£Œ</div><div class="stat-value green">â‚©${fmt(ME.credit_used)}</div></div>
    <div class="stat-card"><div class="stat-label">ëŒ€ê¸° ì¤‘</div><div class="stat-value warn">â‚©${fmt(ME.credit_pending)}</div></div>
  `;

  const { data: apps } = await sb.from('applications').select('*')
    .eq('applicant_id', ME.id).order('created_at', { ascending: false }).limit(5);
  const el = document.getElementById('dash-recent');
  if (!apps || apps.length === 0) {
    el.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>ì‹ ì²­ ë‚´ì—­ì´ ì—†ì–´ìš”</div></div>`;
  } else {
    el.innerHTML = apps.map(a => appListItemHTML(a, false)).join('');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APPLY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function initApply() {
  const { data } = await sb.from('profiles').select('*').eq('id', ME.id).single();
  if (data) { ME = data; refreshHeader(); }
  const avail = Math.max(0, ME.credit_total - ME.credit_used - ME.credit_pending);
  document.getElementById('apply-credit-card').innerHTML = `
    <div class="card-title">ğŸ’° ë‚´ í¬ë ˆë”§ í˜„í™©</div>
    <div class="amount-display">
      <div><div class="label">ì‚¬ìš© ê°€ëŠ¥ í¬ë ˆë”§</div><div class="value">â‚©${fmt(avail)}</div></div>
      <div style="font-size:0.8rem;opacity:0.8;">ì´ â‚©${fmt(ME.credit_total)}<br>ì‚¬ìš© â‚©${fmt(ME.credit_used + ME.credit_pending)}</div>
    </div>`;
  if (entries.length === 0) addEntry();
  else renderEntries();
}

function addEntry() {
  entries.push({
    id: Date.now(), date: todayStr(), category: '', description: '',
    receiptDataUrl: null, receiptFile: null,
    participants: [{ userId: ME.id, name: ME.name, amount: '' }]
  });
  renderEntries();
}

function removeEntry(idx) {
  entries.splice(idx, 1);
  if (entries.length === 0) addEntry(); else renderEntries();
}

function addParticipant(idx) {
  entries[idx].participants.push({ userId:'', name:'', amount:'' });
  renderEntries();
}

function removeParticipant(eIdx, pIdx) {
  entries[eIdx].participants.splice(pIdx, 1);
  renderEntries();
}

async function renderEntries() {
  const { data: approvedUsers } = await sb.from('profiles')
    .select('id,name,email')
    .eq('role','user').eq('status','approved').neq('id', ME.id);
  const users = approvedUsers || [];

  const container = document.getElementById('app-entries');
  container.innerHTML = '';
  entries.forEach((e, ei) => {
    const et = e.participants.reduce((s,p)=>s+(parseFloat(p.amount)||0),0);
    const catBtns = ['boardgame','escape','etc'].map(c=>{
      const lbl = {boardgame:'ğŸ² ë³´ë“œê²Œì„',escape:'ğŸ” ë°©íƒˆì¶œ',etc:'ğŸ“¦ ê¸°íƒ€'}[c];
      return `<button class="pill-opt ${e.category===c?'selected':''}" onclick="setEntryField(${ei},'category','${c}')">${lbl}</button>`;
    }).join('');

    const pBlocks = e.participants.map((p,pi)=>{
      const isSelf = pi===0;
      const nameF = isSelf
        ? `<div style="font-size:0.88rem;font-weight:600;padding:9px 0;">${p.name}</div>`
        : `<select class="form-select" onchange="setParticipant(${ei},${pi},'userId',this.value)" style="font-size:0.85rem;">
            <option value="">íšŒì› ì„ íƒ</option>
            ${users.map(u=>`<option value="${u.id}" ${p.userId===u.id?'selected':''}>${u.name} (${u.email})</option>`).join('')}
           </select>`;
      return `<div class="participant-block">
        <div class="participant-header">
          <span class="participant-label">${isSelf?'ğŸ‘¤ ë³¸ì¸':`ğŸ‘¥ ê³µë™ì´ìš©ì ${pi}`}</span>
          ${!isSelf?`<button class="btn btn-ghost btn-xs" onclick="removeParticipant(${ei},${pi})">âœ•</button>`:''}
        </div>
        ${nameF}
        <div class="form-group" style="margin-bottom:0;">
          <label class="form-label">ì‹ ì²­ê¸ˆì•¡ (ì›)</label>
          <input class="form-input" type="number" placeholder="0" value="${p.amount}"
            oninput="setParticipant(${ei},${pi},'amount',this.value)">
        </div>
      </div>`;
    }).join('');

    const recZone = e.receiptDataUrl
      ? `<div class="receipt-zone has-file" onclick="triggerReceipt(${ei})">
          <div style="font-size:0.82rem;color:var(--success);font-weight:600;">âœ… ì˜ìˆ˜ì¦ ì²¨ë¶€ ì™„ë£Œ</div>
          <img src="${e.receiptDataUrl}" alt="ì˜ìˆ˜ì¦">
          <button class="receipt-remove" onclick="removeReceipt(event,${ei})">âœ•</button>
         </div>`
      : `<div class="receipt-zone" onclick="triggerReceipt(${ei})">
          <div style="font-size:1.5rem;margin-bottom:6px;">ğŸ“</div>
          <div style="font-size:0.88rem;font-weight:600;color:var(--primary);">ì˜ìˆ˜ì¦ ì‚¬ì§„ ì²¨ë¶€ <span style="color:var(--danger);">*í•„ìˆ˜</span></div>
          <div style="font-size:0.78rem;color:var(--text-muted);margin-top:4px;">ìµœëŒ€ 2MB Â· JPG, PNG</div>
         </div>`;

    const card = document.createElement('div');
    card.className = 'entry-card';
    card.innerHTML = `
      <div class="entry-card-header">
        <div class="entry-card-title"><span class="entry-num">${ei+1}</span> ì‹ ì²­ í•­ëª©</div>
        ${entries.length>1?`<button class="btn btn-ghost btn-xs" onclick="removeEntry(${ei})">ğŸ—‘ ì‚­ì œ</button>`:''}
      </div>
      <div class="form-group">
        <label class="form-label">ì¼ì<span class="req">*</span></label>
        <input class="form-input" type="date" value="${e.date}" onchange="setEntryField(${ei},'date',this.value)">
      </div>
      <div class="form-group">
        <label class="form-label">ì‹ ì²­êµ¬ë¶„<span class="req">*</span></label>
        <div class="pill-select-row">${catBtns}</div>
      </div>
      <div class="form-group">
        <label class="form-label">ì´ìš©ë‚´ìš©<span class="req">*</span></label>
        <input class="form-input" type="text" placeholder="ì˜ˆ: ë³´ë“œê²Œì„ì¹´í˜ 2ì¸ ì…ì¥" value="${e.description||''}"
          onchange="setEntryField(${ei},'description',this.value)">
      </div>
      ${pBlocks}
      <button class="btn btn-outline btn-sm btn-full mt-2" onclick="addParticipant(${ei})">ï¼‹ ê³µë™ì´ìš©ì ì¶”ê°€</button>
      <div class="entry-total"><span class="et-label">í•­ëª© í•©ê³„</span><span class="et-value" id="et-${ei}">â‚©${fmt(et)}</span></div>
      <div class="form-group mt-2">
        <label class="form-label">ì˜ìˆ˜ì¦<span class="req">*</span></label>
        ${recZone}
        <input type="file" accept="image/*" id="file-${ei}" style="display:none" onchange="handleReceipt(${ei},this)">
      </div>`;
    container.appendChild(card);
  });
  updateFloatingTotal();
}

function setEntryField(idx, field, val) {
  entries[idx][field] = val;
  if (field==='category') renderEntries(); else updateFloatingTotal();
}

function setParticipant(eIdx, pIdx, field, val) {
  if (field==='userId') {
    // find user from supabase cache â€” just store id, fetch name later
    entries[eIdx].participants[pIdx].userId = val;
    // name will be set from select option text
    const sel = document.querySelector(`#app-entries .entry-card:nth-child(${eIdx+1}) select`);
    if (sel) entries[eIdx].participants[pIdx].name = sel.options[sel.selectedIndex]?.text?.split(' (')[0] || '';
  } else {
    entries[eIdx].participants[pIdx][field] = val;
  }
  const tot = entries[eIdx].participants.reduce((s,p)=>s+(parseFloat(p.amount)||0),0);
  const el = document.getElementById('et-'+eIdx);
  if (el) el.textContent = 'â‚©'+fmt(tot);
  updateFloatingTotal();
}

function updateFloatingTotal() {
  const t = entries.reduce((s,e)=>s+e.participants.reduce((ss,p)=>ss+(parseFloat(p.amount)||0),0),0);
  document.getElementById('float-total').textContent = 'â‚©'+fmt(t);
}

function triggerReceipt(idx) { document.getElementById('file-'+idx).click(); }
function removeReceipt(event, idx) {
  event.stopPropagation();
  entries[idx].receiptDataUrl = null; entries[idx].receiptFile = null;
  renderEntries();
}
function handleReceipt(idx, input) {
  const file = input.files[0]; if (!file) return;
  // 2MB ì œí•œ
  if (file.size > MAX_FILE_BYTES) {
    toast(`íŒŒì¼ í¬ê¸°ê°€ 2MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤ (${(file.size/1024/1024).toFixed(1)}MB)`, 'error');
    input.value = ''; return;
  }
  entries[idx].receiptFile = file;
  const reader = new FileReader();
  reader.onload = e => { entries[idx].receiptDataUrl = e.target.result; renderEntries(); toast('ì˜ìˆ˜ì¦ ì²¨ë¶€ ì™„ë£Œ âœ…','success'); };
  reader.readAsDataURL(file);
}

async function submitApplication() {
  // Validate
  for (let i=0; i<entries.length; i++) {
    const e = entries[i];
    if (!e.date) { toast(`í•­ëª© ${i+1}: ì¼ì ì„ íƒ`,'error'); return; }
    if (!e.category) { toast(`í•­ëª© ${i+1}: ì‹ ì²­êµ¬ë¶„ ì„ íƒ`,'error'); return; }
    if (!e.description?.trim()) { toast(`í•­ëª© ${i+1}: ì´ìš©ë‚´ìš© ì…ë ¥`,'error'); return; }
    if (!e.receiptDataUrl) { toast(`í•­ëª© ${i+1}: ì˜ìˆ˜ì¦ ì²¨ë¶€ í•„ìˆ˜`,'error'); return; }
    for (let j=1; j<e.participants.length; j++) if (!e.participants[j].userId) { toast(`í•­ëª© ${i+1}: ê³µë™ì´ìš©ì ì„ íƒ`,'error'); return; }
    const tot = e.participants.reduce((s,p)=>s+(parseFloat(p.amount)||0),0);
    if (tot<=0) { toast(`í•­ëª© ${i+1}: ì‹ ì²­ê¸ˆì•¡ ì…ë ¥`,'error'); return; }
  }

  const acname = document.getElementById('apply-acname').value.trim();
  const bank   = document.getElementById('apply-bank').value;
  const acnum  = document.getElementById('apply-acnum').value.trim();
  if (!acname||!bank||!acnum) { toast('í™˜ê¸‰ ê³„ì¢Œ ì •ë³´ ì…ë ¥','error'); return; }

  // Credit check
  const { data: profiles } = await sb.from('profiles').select('id,name,credit_total,credit_used,credit_pending').eq('status','approved');
  const creditReq = {};
  for (let e of entries) for (let p of e.participants) {
    const a = parseFloat(p.amount)||0; if (!p.userId||a<=0) continue;
    creditReq[p.userId] = (creditReq[p.userId]||0)+a;
  }
  for (let [uid, req] of Object.entries(creditReq)) {
    const u = profiles?.find(u=>u.id===uid);
    if (!u) continue;
    const avail = Math.max(0, u.credit_total - u.credit_used - u.credit_pending);
    if (req > avail) { toast(`${u.name}ë‹˜ í¬ë ˆë”§ ë¶€ì¡± (ê°€ëŠ¥: â‚©${fmt(avail)})`, 'error'); return; }
  }

  // Upload receipts to Supabase Storage
  toast('ì˜ìˆ˜ì¦ ì—…ë¡œë“œ ì¤‘...', '');
  const entryData = [];
  for (let i=0; i<entries.length; i++) {
    const e = entries[i];
    let receiptUrl = null;
    if (e.receiptFile) {
      const ext = e.receiptFile.name.split('.').pop();
      const path = `receipts/${ME.id}/${Date.now()}_${i}.${ext}`;
      const { data: uploadData, error: upErr } = await sb.storage
        .from('receipts')
        .upload(path, e.receiptFile, { contentType: e.receiptFile.type, upsert: false });
      if (!upErr) {
        const { data: { publicUrl } } = sb.storage.from('receipts').getPublicUrl(path);
        receiptUrl = publicUrl;
      } else {
        console.error('Upload error:', upErr);
        toast(`í•­ëª© ${i+1} ì˜ìˆ˜ì¦ ì—…ë¡œë“œ ì‹¤íŒ¨: ${upErr.message}`, 'error');
        return;
      }
    }
    entryData.push({
      date: e.date, category: e.category, description: e.description,
      receipt_url: receiptUrl,
      total_amount: e.participants.reduce((s,p)=>s+(parseFloat(p.amount)||0),0),
      participants: e.participants.map(p=>({ userId:p.userId, name:p.name, amount:parseFloat(p.amount)||0 }))
    });
  }

  const totalAmt = entryData.reduce((s,e)=>s+e.total_amount,0);
  const { data: app, error: appErr } = await sb.from('applications').insert({
    applicant_id: ME.id,
    applicant_name: ME.name,
    status: 'pending',
    bank_name: bank,
    account_name: acname,
    account_num: acnum,
    note: document.getElementById('apply-note').value,
    entries: entryData,
    total_amount: totalAmt,
  }).select().single();

  if (appErr) { toast('ì‹ ì²­ ì €ì¥ ì‹¤íŒ¨: '+appErr.message,'error'); return; }

  // Update pending credits
  for (let [uid, amt] of Object.entries(creditReq)) {
    const u = profiles?.find(u=>u.id===uid);
    if (!u) continue;
    await sb.from('profiles').update({ credit_pending: u.credit_pending + amt }).eq('id', uid);
  }

  addLog(`ì‹ ì²­ ì œì¶œ: ${app.id} â‚©${fmt(totalAmt)}`, ME.id);
  toast('âœ… ì‹ ì²­ ì™„ë£Œ!','success');
  entries = []; clearApplyForm();
  navigateTo('myapps');
}

function clearApplyForm() {
  ['apply-acname','apply-bank','apply-acnum','apply-note'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MY APPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderMyApps() {
  document.getElementById('myapps-list').innerHTML = skeletonList(3);
  const { data: apps, error } = await sb.from('applications')
    .select('*').eq('applicant_id', ME.id).order('created_at',{ascending:false});

  const el = document.getElementById('myapps-list');
  if (!apps || apps.length===0) {
    el.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>ì‹ ì²­ ë‚´ì—­ ì—†ìŒ</div><button class="btn btn-accent mt-2" onclick="navigateTo('apply')">ì‹ ì²­í•˜ê¸°</button></div>`;
    return;
  }
  el.innerHTML = apps.map(a=>appListItemHTML(a,true)).join('');
}

function appListItemHTML(a, showActions=true) {
  const ents = a.entries || [];
  const cats = ents.map(e=>catLabel(e.category)).join(', ');
  return `<div class="app-list-item" onclick="openDetail('${a.id}')">
    <div class="app-list-row">
      <div class="app-list-name">${a.applicant_name} Â· ${ents.length}ê±´</div>
      <div>${statusBadge(a.status)}</div>
    </div>
    <div class="app-list-row">
      <div class="app-list-amount">â‚©${fmt(a.total_amount)}</div>
      <div class="app-list-date">${fmtDate(a.created_at)}</div>
    </div>
    <div class="app-list-meta">${cats}</div>
    ${showActions && a.status==='pending' ? `
    <div class="app-list-actions" onclick="event.stopPropagation()">
      <button class="btn btn-ghost btn-xs" onclick="confirmCancelApp('${a.id}')">ğŸš« ì‹ ì²­ ì·¨ì†Œ</button>
    </div>` : ''}
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let detailAppId='';
async function openDetail(id, isAdmin=false) {
  detailAppId = id;
  const { data: app } = await sb.from('applications').select('*').eq('id',id).single();
  if (!app) return;
  const isAdm = isAdmin || ME.role==='admin';

  document.getElementById('modal-detail-title').textContent = `ğŸ“„ ì‹ ì²­ ìƒì„¸ â€” ${fmtDate(app.created_at)}`;

  const entriesHtml = (app.entries||[]).map((e,i)=>`
    <div style="background:var(--surface2);border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid var(--border);">
      <div style="font-weight:700;color:var(--primary-dark);margin-bottom:6px;">
        ${catLabel(e.category)} Â· ${e.date} Â· <span style="color:var(--primary);">â‚©${fmt(e.total_amount)}</span>
      </div>
      <div style="font-size:0.88rem;margin-bottom:8px;">${e.description}</div>
      ${(e.participants||[]).map(p=>`
        <div style="display:flex;justify-content:space-between;font-size:0.85rem;padding:4px 0;border-bottom:1px dashed var(--border);">
          <span>${p.name||'?'}</span><span style="font-weight:700;">â‚©${fmt(p.amount)}</span>
        </div>`).join('')}
      ${e.receipt_url ? `<div style="margin-top:10px;"><a href="${e.receipt_url}" target="_blank" style="color:var(--primary);font-size:0.82rem;">ğŸ–¼ ì˜ìˆ˜ì¦ ë³´ê¸°</a><br><img src="${e.receipt_url}" style="max-width:100%;border-radius:8px;margin-top:6px;" loading="lazy"></div>` : ''}
    </div>`).join('');

  document.getElementById('modal-detail-body').innerHTML = `
    <div style="margin-bottom:14px;">
      <div class="detail-row"><span class="detail-key">ì‹ ì²­ì</span><span class="detail-val">${app.applicant_name}</span></div>
      <div class="detail-row"><span class="detail-key">ìƒíƒœ</span><span class="detail-val">${statusBadge(app.status)}</span></div>
      <div class="detail-row"><span class="detail-key">ì‹ ì²­ì¼</span><span class="detail-val">${fmtDate(app.created_at,true)}</span></div>
      ${app.approved_at?`<div class="detail-row"><span class="detail-key">ì²˜ë¦¬ì¼</span><span class="detail-val">${fmtDate(app.approved_at,true)}</span></div>`:''}
      <div class="detail-row"><span class="detail-key">í™˜ê¸‰ê³„ì¢Œ</span><span class="detail-val">${app.bank_name} ${app.account_num}<br>(${app.account_name})</span></div>
      ${app.note?`<div class="detail-row"><span class="detail-key">ë¹„ê³ </span><span class="detail-val">${app.note}</span></div>`:''}
      ${app.admin_note?`<div class="detail-row"><span class="detail-key">ê´€ë¦¬ìë©”ëª¨</span><span class="detail-val" style="color:var(--primary);">${app.admin_note}</span></div>`:''}
    </div>
    <div class="section-divider"></div>
    <div class="card-title" style="margin-bottom:10px;">ì‹ ì²­ í•­ëª©</div>
    ${entriesHtml}
    <div class="amount-display mt-2">
      <div><div class="label">ì´ ì‹ ì²­ê¸ˆì•¡</div><div class="value">â‚©${fmt(app.total_amount)}</div></div>
      <div style="font-size:0.8rem;opacity:0.8;">${(app.entries||[]).length}ê°œ í•­ëª©</div>
    </div>`;

  let actions = `<button class="btn btn-outline" onclick="closeModal('modal-detail')">ë‹«ê¸°</button>`;
  if (isAdm) {
    actions += `<button class="btn btn-info btn-sm" onclick="openPrintPreview('${id}')">ğŸ–¨ï¸ ì¸ì‡„</button>
                <button class="btn btn-warn btn-sm" onclick="openEdit('${id}')">âœï¸ ìˆ˜ì •</button>`;
    if (app.status==='pending') {
      actions += `<button class="btn btn-success btn-sm" onclick="confirmApprove('${id}')">âœ… ìŠ¹ì¸</button>
                  <button class="btn btn-danger btn-sm" onclick="confirmReject('${id}')">âŒ ë°˜ë ¤</button>`;
    }
  } else if (app.status==='pending') {
    actions += `<button class="btn btn-danger" onclick="confirmCancelApp('${id}')">ì‹ ì²­ ì·¨ì†Œ</button>`;
  }
  document.getElementById('modal-detail-actions').innerHTML = actions;
  openModal('modal-detail');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIRM DIALOG HELPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showConfirm({ icon='âš ï¸', title, msg, okLabel='í™•ì¸', okClass='btn-danger', onOk }) {
  document.getElementById('confirm-icon').textContent = icon;
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-msg').textContent = msg;
  const btn = document.getElementById('confirm-ok-btn');
  btn.textContent = okLabel;
  btn.className = 'btn ' + okClass;
  btn.onclick = () => { closeModal('modal-confirm'); onOk(); };
  openModal('modal-confirm');
}

function confirmApprove(id) {
  showConfirm({ icon:'âœ…', title:'ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', msg:'ìŠ¹ì¸ ì‹œ í•´ë‹¹ í¬ë ˆë”§ì´ ì‚¬ìš© ì²˜ë¦¬ë©ë‹ˆë‹¤.', okLabel:'ìŠ¹ì¸', okClass:'btn-success', onOk:()=>approveApp(id) });
}
function confirmReject(id) {
  showConfirm({ icon:'âŒ', title:'ì‹ ì²­ì„ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', msg:'ë°˜ë ¤ ì‹œ í¬ë ˆë”§ì´ ë³µêµ¬ë©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', okLabel:'ë°˜ë ¤', okClass:'btn-danger', onOk:()=>rejectApp(id) });
}
function confirmCancelApp(id) {
  showConfirm({ icon:'ğŸš«', title:'ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', msg:'ì·¨ì†Œ ì‹œ í¬ë ˆë”§ì´ ë³µêµ¬ë©ë‹ˆë‹¤.', okLabel:'ì·¨ì†Œí•˜ê¸°', okClass:'btn-danger', onOk:()=>cancelApp(id) });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CANCEL (USER)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function cancelApp(id) {
  const { data: app } = await sb.from('applications').select('*').eq('id',id).single();
  if (!app || app.status!=='pending') { toast('ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ë§Œ ì·¨ì†Œ ê°€ëŠ¥í•©ë‹ˆë‹¤','error'); return; }

  await sb.from('applications').update({status:'cancelled', updated_at:nowISO()}).eq('id',id);
  await restorePending(app);
  addLog(`ì‹ ì²­ ì·¨ì†Œ: ${id}`, ME.id);
  toast('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤','success');
  closeModal('modal-detail');
  renderMyApps();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderAdminDash() {
  const [{ count: userCount }, { count: pendingCount }, { count: totalCount }, { data: approvedApps }] = await Promise.all([
    sb.from('profiles').select('*',{count:'exact',head:true}).eq('role','user'),
    sb.from('applications').select('*',{count:'exact',head:true}).eq('status','pending'),
    sb.from('applications').select('*',{count:'exact',head:true}),
    sb.from('applications').select('total_amount').in('status',['approved','mod-approved'])
  ]);
  const totalPaid = (approvedApps||[]).reduce((s,a)=>s+a.total_amount,0);

  document.getElementById('admin-stats').innerHTML = `
    <div class="stat-card"><div class="stat-label">ì „ì²´ íšŒì›</div><div class="stat-value blue">${userCount||0}ëª…</div></div>
    <div class="stat-card"><div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸°</div><div class="stat-value accent">${pendingCount||0}ê±´ <span class="pending-dot"></span></div></div>
    <div class="stat-card"><div class="stat-label">ì „ì²´ ì‹ ì²­</div><div class="stat-value">${totalCount||0}ê±´</div></div>
    <div class="stat-card"><div class="stat-label">ì´ ì§€ê¸‰ì•¡</div><div class="stat-value green">â‚©${fmt(totalPaid)}</div></div>`;

  const { data: pending } = await sb.from('applications').select('*').eq('status','pending').order('created_at',{ascending:false}).limit(20);
  const el = document.getElementById('admin-pending');
  if (!pending||pending.length===0) { el.innerHTML=`<div class="empty-state"><div class="empty-icon">âœ…</div><div>ëŒ€ê¸° ì¤‘ ì—†ìŒ</div></div>`; return; }
  el.innerHTML = pending.map(a=>`
    <div class="app-list-item" onclick="openDetail('${a.id}',true)">
      <div class="app-list-row">
        <div class="app-list-name">${a.applicant_name}</div>
        <div>${statusBadge(a.status)}</div>
      </div>
      <div class="app-list-row">
        <div class="app-list-amount">â‚©${fmt(a.total_amount)}</div>
        <div class="app-list-date">${fmtDate(a.created_at)}</div>
      </div>
      <div class="app-list-meta">${(a.entries||[]).map(e=>catLabel(e.category)).join(', ')}</div>
      <div class="app-list-actions" onclick="event.stopPropagation()">
        <button class="btn btn-success btn-xs" onclick="confirmApprove('${a.id}')">âœ… ìŠ¹ì¸</button>
        <button class="btn btn-warn btn-xs" onclick="openEdit('${a.id}')">âœï¸</button>
        <button class="btn btn-danger btn-xs" onclick="confirmReject('${a.id}')">âŒ ë°˜ë ¤</button>
        <button class="btn btn-info btn-xs" onclick="openPrintPreview('${a.id}')">ğŸ–¨ï¸</button>
      </div>
    </div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN ALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderAdminAll() {
  document.getElementById('admin-all-list').innerHTML = skeletonList(4);
  const sf = document.getElementById('admin-sf')?.value||'';
  const sq = (document.getElementById('admin-search')?.value||'').toLowerCase().trim();

  let query = sb.from('applications').select('*').order('created_at',{ascending:false});
  if (sf) query = query.eq('status', sf);

  const { data: apps } = await query;
  let filtered = apps || [];
  if (sq) filtered = filtered.filter(a=> a.applicant_name?.toLowerCase().includes(sq) || a.id?.includes(sq) || (a.note||'').toLowerCase().includes(sq));

  document.getElementById('admin-all-count').textContent = `ì´ ${filtered.length}ê±´`;
  const el = document.getElementById('admin-all-list');
  if (!filtered.length) { el.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ”</div><div>ê²°ê³¼ ì—†ìŒ</div></div>`; return; }
  el.innerHTML = filtered.map(a=>`
    <div class="app-list-item" onclick="openDetail('${a.id}',true)">
      <div class="app-list-row">
        <div class="app-list-name">${a.applicant_name}</div>
        <div>${statusBadge(a.status)}</div>
      </div>
      <div class="app-list-row">
        <div class="app-list-amount">â‚©${fmt(a.total_amount)}</div>
        <div class="app-list-date">${fmtDate(a.created_at)}</div>
      </div>
      <div class="app-list-meta">${(a.entries||[]).map(e=>catLabel(e.category)).join(', ')}</div>
      <div class="app-list-actions" onclick="event.stopPropagation()">
        ${a.status==='pending'?`<button class="btn btn-success btn-xs" onclick="confirmApprove('${a.id}')">âœ…</button>`:''}
        <button class="btn btn-warn btn-xs" onclick="openEdit('${a.id}')">âœï¸</button>
        ${a.status==='pending'?`<button class="btn btn-danger btn-xs" onclick="confirmReject('${a.id}')">âŒ</button>`:''}
        <button class="btn btn-info btn-xs" onclick="openPrintPreview('${a.id}')">ğŸ–¨ï¸</button>
      </div>
    </div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APPROVE / REJECT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function approveApp(id) {
  const { data: app } = await sb.from('applications').select('*').eq('id',id).single();
  if (!app) return;

  const newStatus = app.status==='pending' ? 'approved' : 'mod-approved';
  await sb.from('applications').update({status:newStatus, approved_at:nowISO(), approved_by:ME.id, updated_at:nowISO()}).eq('id',id);

  // pending â†’ used
  const { data: profiles } = await sb.from('profiles').select('*').in('id', app.entries.flatMap(e=>e.participants.map(p=>p.userId)).filter(Boolean));
  for (let e of (app.entries||[])) for (let p of e.participants) {
    const amt = parseFloat(p.amount)||0; if (!p.userId||amt<=0) continue;
    const u = profiles?.find(u=>u.id===p.userId); if (!u) continue;
    await sb.from('profiles').update({ credit_pending: Math.max(0,u.credit_pending-amt), credit_used: u.credit_used+amt }).eq('id',p.userId);
  }
  addLog(`ìŠ¹ì¸: ${id} â‚©${fmt(app.total_amount)}`, ME.id);
  toast('âœ… ìŠ¹ì¸ ì™„ë£Œ!','success');
  closeModal('modal-detail');
  if (currentPage==='admin') renderAdminDash();
  else if (currentPage==='admin-all') renderAdminAll();
}

async function rejectApp(id) {
  const { data: app } = await sb.from('applications').select('*').eq('id',id).single();
  if (!app) return;
  await sb.from('applications').update({status:'rejected', updated_at:nowISO()}).eq('id',id);
  await restorePending(app);
  addLog(`ë°˜ë ¤: ${id}`, ME.id);
  toast('ë°˜ë ¤ ì²˜ë¦¬','warning');
  closeModal('modal-detail');
  if (currentPage==='admin') renderAdminDash();
  else if (currentPage==='admin-all') renderAdminAll();
}

async function restorePending(app) {
  const { data: profiles } = await sb.from('profiles').select('*').in('id', (app.entries||[]).flatMap(e=>e.participants.map(p=>p.userId)).filter(Boolean));
  for (let e of (app.entries||[])) for (let p of e.participants) {
    const amt = parseFloat(p.amount)||0; if (!p.userId||amt<=0) continue;
    const u = profiles?.find(u=>u.id===p.userId); if (!u) continue;
    await sb.from('profiles').update({ credit_pending: Math.max(0,u.credit_pending-amt) }).eq('id',p.userId);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN EDIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function openEdit(id) {
  editId = id;
  const { data: app } = await sb.from('applications').select('*').eq('id',id).single();
  if (!app) return;

  const entriesHtml = (app.entries||[]).map((e,i)=>`
    <div style="background:var(--surface2);border-radius:10px;padding:12px;margin-bottom:10px;border:1px solid var(--border);">
      <div style="font-weight:700;font-size:0.9rem;margin-bottom:8px;">í•­ëª© ${i+1}</div>
      <div class="form-row-2">
        <div class="form-group"><label class="form-label">ì¼ì</label><input class="form-input" type="date" id="ed-date-${i}" value="${e.date}"></div>
        <div class="form-group"><label class="form-label">êµ¬ë¶„</label>
          <select class="form-select" id="ed-cat-${i}">
            <option value="boardgame" ${e.category==='boardgame'?'selected':''}>ë³´ë“œê²Œì„</option>
            <option value="escape" ${e.category==='escape'?'selected':''}>ë°©íƒˆì¶œ</option>
            <option value="etc" ${e.category==='etc'?'selected':''}>ê¸°íƒ€</option>
          </select></div>
      </div>
      <div class="form-group"><label class="form-label">ì´ìš©ë‚´ìš©</label><input class="form-input" type="text" id="ed-desc-${i}" value="${e.description}"></div>
      ${(e.participants||[]).map((p,pi)=>`
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
          <span style="flex:1;font-size:0.83rem;color:var(--text-muted);">${p.name||'?'}</span>
          <input class="form-input" type="number" id="ed-amt-${i}-${pi}" value="${p.amount}" style="flex:1;font-size:0.88rem;">
        </div>`).join('')}
    </div>`).join('');

  document.getElementById('modal-edit-body').innerHTML = `
    <div class="form-row-2">
      <div class="form-group"><label class="form-label">ì€í–‰</label><input class="form-input" id="ed-bank" value="${app.bank_name}"></div>
      <div class="form-group"><label class="form-label">ì˜ˆê¸ˆì£¼</label><input class="form-input" id="ed-acname" value="${app.account_name}"></div>
    </div>
    <div class="form-group"><label class="form-label">ê³„ì¢Œë²ˆí˜¸</label>
      <input class="form-input" id="ed-acnum" value="${app.account_num}" inputmode="numeric" oninput="this.value=this.value.replace(/\\D/g,'')">
    </div>
    <div class="form-group"><label class="form-label">ê´€ë¦¬ì ë©”ëª¨</label><textarea class="form-textarea" id="ed-note">${app.admin_note||''}</textarea></div>
    <div class="section-divider"></div>
    ${entriesHtml}`;

  document.getElementById('modal-edit-actions').innerHTML = `
    <button class="btn btn-outline" onclick="closeModal('modal-edit')">ì·¨ì†Œ</button>
    <button class="btn btn-warn btn-sm" onclick="saveEdit(false)">ìˆ˜ì • ì €ì¥</button>
    <button class="btn btn-success btn-sm" onclick="saveEdit(true)">ìˆ˜ì •+ìŠ¹ì¸</button>`;
  closeModal('modal-detail');
  openModal('modal-edit');
}

async function saveEdit(andApprove) {
  const { data: app } = await sb.from('applications').select('*').eq('id',editId).single();
  if (!app) return;

  const updEntries = app.entries.map((e,i)=>{
    const newPs = e.participants.map((p,pi)=>({ ...p, amount: parseFloat(document.getElementById(`ed-amt-${i}-${pi}`)?.value)||0 }));
    return { ...e,
      date: document.getElementById(`ed-date-${i}`)?.value||e.date,
      category: document.getElementById(`ed-cat-${i}`)?.value||e.category,
      description: document.getElementById(`ed-desc-${i}`)?.value||e.description,
      participants: newPs,
      total_amount: newPs.reduce((s,p)=>s+(p.amount||0),0)
    };
  });
  const newTotal = updEntries.reduce((s,e)=>s+e.total_amount,0);

  const upd = {
    bank_name: document.getElementById('ed-bank').value,
    account_name: document.getElementById('ed-acname').value,
    account_num: document.getElementById('ed-acnum').value,
    admin_note: document.getElementById('ed-note').value,
    entries: updEntries, total_amount: newTotal, updated_at: nowISO()
  };
  if (andApprove) { upd.status='mod-approved'; upd.approved_at=nowISO(); upd.approved_by=ME.id; }

  await sb.from('applications').update(upd).eq('id',editId);

  if (andApprove) {
    const { data: profiles } = await sb.from('profiles').select('*');
    for (let e of updEntries) for (let p of e.participants) {
      const amt = p.amount||0; if (!p.userId||amt<=0) continue;
      const u = profiles?.find(u=>u.id===p.userId); if (!u) continue;
      await sb.from('profiles').update({ credit_pending:Math.max(0,u.credit_pending-amt), credit_used:u.credit_used+amt }).eq('id',p.userId);
    }
  }

  addLog(`ìˆ˜ì •${andApprove?'+ìŠ¹ì¸':''}: ${editId}`, ME.id);
  toast(andApprove?'âœ… ìˆ˜ì • í›„ ìŠ¹ì¸ ì™„ë£Œ':'âœï¸ ìˆ˜ì • ì™„ë£Œ','success');
  closeModal('modal-edit');
  if (currentPage==='admin') renderAdminDash();
  else if (currentPage==='admin-all') renderAdminAll();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN MEMBERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderAdminMembers() {
  document.getElementById('admin-members-list').innerHTML = skeletonList(3);
  const { data: users } = await sb.from('profiles').select('*').order('created_at',{ascending:false});
  const el = document.getElementById('admin-members-list');
  el.innerHTML = (users||[]).map(u=>{
    const avail = Math.max(0,u.credit_total-u.credit_used-u.credit_pending);
    const si = u.status==='approved'?'âœ…':u.status==='pending'?'â³':'âŒ';
    return `<div class="card" style="margin-bottom:10px;">
      <div class="flex-between mb-2">
        <div>
          <div style="font-weight:700;font-size:0.95rem;">${u.name} ${u.role==='admin'?'<span class="admin-tag">ADMIN</span>':''}</div>
          <div style="font-size:0.78rem;color:var(--text-muted);">${u.email} Â· ${u.provider||'email'}</div>
        </div>
        <div>${si}</div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px;">
        <div style="background:var(--surface2);border-radius:8px;padding:8px;text-align:center;">
          <div style="font-size:0.68rem;color:var(--text-muted);">ì´í¬ë ˆë”§</div>
          <div style="font-size:0.88rem;font-weight:700;color:var(--primary);">â‚©${fmt(u.credit_total)}</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:8px;text-align:center;">
          <div style="font-size:0.68rem;color:var(--text-muted);">ì‚¬ìš©</div>
          <div style="font-size:0.88rem;font-weight:700;color:var(--success);">â‚©${fmt(u.credit_used)}</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:8px;text-align:center;">
          <div style="font-size:0.68rem;color:var(--text-muted);">ê°€ìš©</div>
          <div style="font-size:0.88rem;font-weight:700;color:var(--accent);">â‚©${fmt(avail)}</div>
        </div>
      </div>
      <div class="btn-row">
        ${u.status==='pending'?`<button class="btn btn-success btn-sm" onclick="approveUser('${u.id}')">âœ… ìŠ¹ì¸</button>`:''}
        <button class="btn btn-outline btn-sm" onclick="openCreditEdit('${u.id}')">ğŸ’° í¬ë ˆë”§</button>
        ${u.status!=='rejected'&&u.role!=='admin'?`<button class="btn btn-danger btn-sm" onclick="confirmRejectUser('${u.id}','${u.name}')">ê±°ì ˆ</button>`:''}
      </div>
    </div>`;
  }).join('');
}

async function approveUser(uid) {
  const { data: u } = await sb.from('profiles').select('*').eq('id',uid).single();
  if (!u) return;
  await sb.from('profiles').update({ status:'approved', credit_total: u.credit_total||30000 }).eq('id',uid);
  addLog(`íšŒì› ìŠ¹ì¸: ${u.email}`, ME.id);
  toast(`${u.name} ìŠ¹ì¸ ì™„ë£Œ + í¬ë ˆë”§ â‚©${fmt(u.credit_total||30000)} ì§€ê¸‰`,'success');
  renderAdminMembers();
}

function confirmRejectUser(uid, name) {
  showConfirm({ icon:'ğŸš«', title:'íšŒì›ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', msg:`${name}ì˜ ê°€ì… ì‹ ì²­ì„ ê±°ì ˆí•©ë‹ˆë‹¤.`, okLabel:'ê±°ì ˆ', okClass:'btn-danger', onOk:()=>rejectUser(uid,name) });
}
async function rejectUser(uid, name) {
  await sb.from('profiles').update({status:'rejected'}).eq('id',uid);
  addLog(`íšŒì› ê±°ì ˆ: ${uid}`, ME.id);
  toast('ê±°ì ˆ ì²˜ë¦¬','warning');
  renderAdminMembers();
}

async function openCreditEdit(uid) {
  editCreditUid = uid;
  const { data: u } = await sb.from('profiles').select('*').eq('id',uid).single();
  if (!u) return;
  document.getElementById('modal-credit-body').innerHTML = `
    <div style="margin-bottom:12px;font-weight:700;">${u.name} (${u.email})</div>
    <div class="form-group"><label class="form-label">ì´ í¬ë ˆë”§</label><input class="form-input" type="number" id="cr-total" value="${u.credit_total}"></div>
    <div class="form-group"><label class="form-label">ì‚¬ìš© í¬ë ˆë”§ (ì¡°ì •)</label><input class="form-input" type="number" id="cr-used" value="${u.credit_used}"></div>
    <div class="text-muted">ëŒ€ê¸°: â‚©${fmt(u.credit_pending)}</div>`;
  openModal('modal-credit');
}
async function saveCreditEdit() {
  const total = parseFloat(document.getElementById('cr-total').value)||0;
  const used  = parseFloat(document.getElementById('cr-used').value)||0;
  await sb.from('profiles').update({credit_total:total,credit_used:used}).eq('id',editCreditUid);
  addLog(`í¬ë ˆë”§ ìˆ˜ì •: ${editCreditUid}`, ME.id);
  toast('í¬ë ˆë”§ ìˆ˜ì • ì™„ë£Œ','success');
  closeModal('modal-credit');
  renderAdminMembers();
}

function openCreateUserModal() {
  ['nu-name','nu-email'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('nu-pw').value='4321';
  document.getElementById('nu-credit').value='30000';
  document.getElementById('nu-role').value='user';
  openModal('modal-create-user');
}
async function createUser() {
  const name  = document.getElementById('nu-name').value.trim();
  const email = document.getElementById('nu-email').value.trim();
  const pw    = document.getElementById('nu-pw').value;
  const credit= parseFloat(document.getElementById('nu-credit').value)||0;
  const role  = document.getElementById('nu-role').value;
  if (!name||!email) { toast('ì´ë¦„ê³¼ ì´ë©”ì¼ í•„ìˆ˜','error'); return; }

  const { data, error } = await sb.auth.admin ? null : await sb.auth.signUp({email, password:pw, options:{data:{name}}});
  // Fallback: insert profile directly (admin context)
  const uid = 'manual_'+Date.now();
  await sb.from('profiles').insert({ id:uid, email, name, role, status:'approved', provider:'admin', credit_total:credit, credit_used:0, credit_pending:0 });
  addLog(`ê³„ì • ìƒì„±: ${email}`, ME.id);
  toast(`${name} ê³„ì • ìƒì„± ì™„ë£Œ`,'success');
  closeModal('modal-create-user');
  renderAdminMembers();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function renderLogs() {
  document.getElementById('logs-content').innerHTML = `<div class="skeleton sk-card"></div>`.repeat(5);
  const { data: logs } = await sb.from('logs').select('*').order('created_at',{ascending:false}).limit(200);
  const el = document.getElementById('logs-content');
  if (!logs||!logs.length) { el.innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><div>ë¡œê·¸ ì—†ìŒ</div></div>`; return; }
  el.innerHTML = logs.map(l=>`
    <div style="display:flex;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);font-size:0.8rem;">
      <div style="color:var(--text-muted);white-space:nowrap;min-width:100px;">${fmtDate(l.created_at,true)}</div>
      <div style="flex:1;">${l.message}</div>
    </div>`).join('');
}
async function clearLogs() {
  showConfirm({ icon:'ğŸ—‘ï¸', title:'ë¡œê·¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', msg:'ëª¨ë“  ì‹œìŠ¤í…œ ë¡œê·¸ê°€ ì‚­ì œë©ë‹ˆë‹¤.', okLabel:'ì´ˆê¸°í™”', okClass:'btn-danger', onOk:async()=>{
    await sb.from('logs').delete().not('id','is',null);
    addLog('ë¡œê·¸ ì´ˆê¸°í™”', ME.id);
    renderLogs();
  }});
}

async function addLog(message, userId) {
  await sb.from('logs').insert({ message, user_id: userId||null });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function openPrintPreview(id) {
  printAppId = id;
  const { data: app } = await sb.from('applications').select('*').eq('id',id).single();
  if (!app) return;

  const topRows = (app.entries||[]).map(e=>{
    const ps = (e.participants||[]).map(p=>`${p.name} â‚©${fmt(p.amount)}`).join(' / ');
    return `<tr>
      <td>${e.date}</td><td>${catLabel(e.category)}</td>
      <td>${e.description}</td><td>${ps}</td>
      <td style="text-align:right;font-weight:700;">â‚©${fmt(e.total_amount)}</td></tr>`;
  }).join('');

  document.getElementById('modal-print-preview').innerHTML = `
    <div style="font-size:10pt;color:#000;">
      <div style="background:#1e3a8a;color:#fff;padding:8px 12px;border-radius:4px;margin-bottom:8px;">
        <div style="font-size:12pt;font-weight:900;">2026ë…„ ë³´ë™ë³´ë™ ê°“ìƒì§€ì›ê¸ˆ ì‹ ì²­ì„œ</div>
        <div style="font-size:8pt;opacity:0.85;">ë³´ë“œê²Œì„ ì§€ì›ê¸ˆ í™˜ê¸‰ ì‹ ì²­ | ì‹ ì²­ì¼: ${fmtDate(app.created_at)} | ID: ${app.id}</div>
      </div>
      <table style="width:100%;border-collapse:collapse;font-size:9pt;margin-bottom:10px;">
        <thead><tr style="background:#1e3a8a;color:#fff;">
          <th style="padding:5px 8px;">ì´ìš©ì¼ì</th><th style="padding:5px 8px;">êµ¬ë¶„</th>
          <th style="padding:5px 8px;">ì´ìš©ë‚´ìš©</th><th style="padding:5px 8px;">ì´ìš©ì(ê¸ˆì•¡)</th>
          <th style="padding:5px 8px;text-align:right;">ì‹ ì²­ê¸ˆì•¡</th>
        </tr></thead>
        <tbody>${topRows}</tbody>
      </table>
      <div style="border:2px solid #1e3a8a;border-radius:4px;padding:8px 12px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
        <span style="font-weight:700;color:#1e3a8a;">ì´ ì‹ ì²­ê¸ˆì•¡ (ì…ê¸ˆ í•„ìš” ê¸ˆì•¡)</span>
        <span style="font-size:13pt;font-weight:900;color:#1e3a8a;">â‚©${fmt(app.total_amount)}</span>
      </div>
      <div style="border:1.5px solid #93C5FD;border-radius:4px;padding:10px 12px;background:#EFF6FF;">
        <div style="font-weight:700;color:#1e40af;margin-bottom:4px;">ğŸ’³ ì…ê¸ˆ ê³„ì¢Œ</div>
        <div style="font-size:9.5pt;"><b>ì€í–‰:</b> ${app.bank_name} &nbsp;|&nbsp; <b>ê³„ì¢Œë²ˆí˜¸:</b> ${app.account_num} &nbsp;|&nbsp; <b>ì˜ˆê¸ˆì£¼:</b> ${app.account_name}</div>
      </div>
    </div>`;
  openModal('modal-print');
}

async function doPrint() {
  const { data: app } = await sb.from('applications').select('*').eq('id',printAppId).single();
  if (!app) return;
  const topRows = (app.entries||[]).map(e=>{
    const ps=(e.participants||[]).map(p=>`${p.name} â‚©${fmt(p.amount)}`).join(' / ');
    return `<tr><td>${e.date}</td><td>${catLabel(e.category)}</td><td>${e.description}</td><td>${ps}</td><td style="text-align:right;font-weight:700;">â‚©${fmt(e.total_amount)}</td></tr>`;
  }).join('');

  document.getElementById('print-area').innerHTML = `
    <div class="print-page">
      <div class="print-header-bar"><div class="print-main-title">ğŸ² 2026ë…„ ë³´ë™ë³´ë™ ê°“ìƒì§€ì›ê¸ˆ ì‹ ì²­ì„œ</div><div class="print-sub">ë³´ë“œê²Œì„ ì§€ì›ê¸ˆ í™˜ê¸‰ ì‹ ì²­</div></div>
      <div class="print-stamp-row"><div class="print-stamp"><div style="font-size:8pt;color:#888;">ì‹ ì²­ì¼</div><div class="stamp-label">${fmtDate(app.created_at)}</div><div style="font-size:7pt;color:#888;">${app.id}</div></div></div>
      <div class="print-section">
        <div class="print-section-title">â–¶ ì´ìš© ë‚´ì—­</div>
        <table class="print-table">
          <thead><tr><th>ì´ìš©ì¼ì</th><th>êµ¬ë¶„</th><th>ì´ìš©ë‚´ìš©</th><th>ì´ìš©ìëª… (ì‹ ì²­ê¸ˆì•¡)</th><th>ì‹ ì²­ê¸ˆì•¡</th></tr></thead>
          <tbody>${topRows}</tbody>
          <tfoot><tr style="background:#EFF6FF;"><td colspan="4" style="text-align:right;font-weight:700;padding:8px 10px;border:1px solid #93C5FD;">í•© ê³„</td><td style="text-align:right;font-weight:900;font-size:12pt;padding:8px 10px;border:1px solid #93C5FD;">â‚©${fmt(app.total_amount)}</td></tr></tfoot>
        </table>
      </div>
      <div class="print-total-box"><span class="print-total-label">ì´ ì‹ ì²­ê¸ˆì•¡</span><span class="print-total-amount">â‚©${fmt(app.total_amount)}</span></div>
      <div class="print-section">
        <div class="print-section-title">â–¶ ì…ê¸ˆ ì •ë³´</div>
        <div class="print-bank-box">
          <div class="print-bank-row"><span class="print-bank-key">ì€í–‰ëª…</span><span>${app.bank_name}</span></div>
          <div class="print-bank-row"><span class="print-bank-key">ê³„ì¢Œë²ˆí˜¸</span><span style="font-size:12pt;font-weight:700;">${app.account_num}</span></div>
          <div class="print-bank-row"><span class="print-bank-key">ì˜ˆê¸ˆì£¼</span><span>${app.account_name}</span></div>
          <div class="print-bank-row" style="margin-top:6px;padding-top:6px;border-top:1px solid #93C5FD;">
            <span class="print-bank-key">ì…ê¸ˆ í•„ìš”ì•¡</span>
            <span style="font-size:14pt;font-weight:900;color:#1e3a8a;">â‚©${fmt(app.total_amount)}</span>
          </div>
        </div>
      </div>
      ${app.note?`<div style="font-size:9pt;color:#555;margin-top:8px;">ğŸ“ ë¹„ê³ : ${app.note}</div>`:''}
      ${app.admin_note?`<div style="font-size:9pt;color:#1e40af;margin-top:4px;">ğŸ’¬ ê´€ë¦¬ìë©”ëª¨: ${app.admin_note}</div>`:''}
      <div class="print-footer">
        <span>2026 ë³´ë™ë³´ë™ ê°“ìƒì§€ì›ê¸ˆ ì§€ì›ì‚¬ì—…</span>
        <div class="print-sig"><div>ìŠ¹ì¸ì ì„œëª…</div><div class="print-sig-line"></div><div>(ì¸)</div></div>
      </div>
    </div>`;
  closeModal('modal-print');
  addLog(`ì¸ì‡„: ${printAppId}`, ME.id);
  setTimeout(()=>window.print(), 200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSV EXPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function exportCSV() {
  const { data: apps } = await sb.from('applications').select('*').order('created_at',{ascending:false});
  const rows = [['ì‹ ì²­ID','ì‹ ì²­ì','ì‹ ì²­ì¼','ì´ê¸ˆì•¡','ìƒíƒœ','ì€í–‰','ê³„ì¢Œ','ì˜ˆê¸ˆì£¼','í•­ëª©ìˆ˜','ë¹„ê³ ']];
  (apps||[]).forEach(a=>{
    rows.push([a.id,a.applicant_name,fmtDate(a.created_at),a.total_amount,a.status,a.bank_name,a.account_num,a.account_name,(a.entries||[]).length,a.note||'']);
  });
  const csv = rows.map(r=>r.map(c=>`"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`ì‹ ì²­ì·¨í•©_${new Date().toLocaleDateString()}.csv`; a.click();
  URL.revokeObjectURL(url);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('open'); }));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toast(msg, type='') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast '+(type||'');
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(()=>{ t.style.transition='0.3s'; t.style.opacity='0'; setTimeout(()=>t.remove(),300); },3000);
}
function fmt(n) { return Number(n||0).toLocaleString('ko-KR'); }
function nowISO() { return new Date().toISOString(); }
function todayStr() { return new Date().toISOString().split('T')[0]; }
function fmtDate(iso, withTime=false) {
  if (!iso) return '-';
  const d = new Date(iso);
  const date = `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
  if (!withTime) return date;
  return date+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
}
function statusBadge(s) {
  const m = {pending:['ëŒ€ê¸°','badge-pending'],approved:['ìŠ¹ì¸','badge-approved'],rejected:['ë°˜ë ¤','badge-rejected'],cancelled:['ì·¨ì†Œ','badge-cancelled'],'mod-approved':['ìˆ˜ì •ìŠ¹ì¸','badge-mod-approved']};
  const [l,c]=m[s]||[s,''];
  return `<span class="badge ${c}">${l}</span>`;
}
function catLabel(c) { return {boardgame:'ğŸ² ë³´ë“œê²Œì„',escape:'ğŸ” ë°©íƒˆì¶œ',etc:'ğŸ“¦ ê¸°íƒ€'}[c]||c||'-'; }
function skeletonList(n) { return `<div class="skeleton sk-card mb-2"></div>`.repeat(n); }
</script>
</body>
</html>
