<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2026ë…„ ë³´ë™ë³´ë™ ê°“ìƒì§€ì›ê¸ˆ ì‹ ì²­ ì‚¬ì´íŠ¸</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Gmarket+Sans:wght@300;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --primary: #2D6A4F;
  --primary-light: #52B788;
  --primary-dark: #1B4332;
  --accent: #F77F00;
  --accent2: #FCBF49;
  --bg: #F0F4F0;
  --surface: #FFFFFF;
  --surface2: #F8FAF8;
  --text: #1A2E1A;
  --text-muted: #6B7C6B;
  --border: #D4E4D4;
  --danger: #E63946;
  --success: #52B788;
  --warning: #F77F00;
  --info: #4895EF;
  --shadow: 0 2px 16px rgba(45,106,79,0.10);
  --radius: 16px;
  --radius-sm: 8px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Noto Sans KR', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

/* â”€â”€ LOADING â”€â”€ */
#loading-screen {
  position: fixed; inset: 0; background: var(--primary-dark);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 9999; transition: opacity 0.5s;
}
#loading-screen .logo-big { font-family: 'Gmarket Sans', sans-serif; font-size: 2.5rem; color: var(--accent2); font-weight: 700; margin-bottom: 8px; }
#loading-screen .sub { color: #B7E4C7; font-size: 1rem; margin-bottom: 32px; }
.spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2); border-top-color: var(--accent2); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ HEADER â”€â”€ */
header {
  background: var(--primary-dark);
  color: #fff;
  padding: 0 24px;
  height: 64px;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
}
.header-logo { font-family: 'Gmarket Sans', sans-serif; font-size: 1.1rem; font-weight: 700; color: var(--accent2); cursor: pointer; }
.header-logo span { color: #B7E4C7; font-weight: 300; font-size: 0.85rem; display: block; }
.header-right { display: flex; align-items: center; gap: 12px; }
.user-chip { background: rgba(255,255,255,0.1); border-radius: 20px; padding: 6px 14px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
.credit-badge { background: var(--accent); color: #fff; border-radius: 12px; padding: 3px 10px; font-size: 0.8rem; font-weight: 700; }
.btn-logout { background: rgba(255,255,255,0.15); border: none; color: #fff; border-radius: 8px; padding: 6px 14px; cursor: pointer; font-size: 0.85rem; font-family: inherit; }
.btn-logout:hover { background: rgba(255,255,255,0.25); }

/* â”€â”€ SIDEBAR â”€â”€ */
.layout { display: flex; min-height: calc(100vh - 64px); }
nav.sidebar {
  width: 220px; min-width: 220px; background: var(--primary-dark);
  padding: 20px 0; display: flex; flex-direction: column; gap: 4px;
}
.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 24px; color: #B7E4C7; cursor: pointer;
  font-size: 0.9rem; border-left: 3px solid transparent;
  transition: all 0.2s; white-space: nowrap;
}
.nav-item:hover { background: rgba(255,255,255,0.07); color: #fff; }
.nav-item.active { background: rgba(82,183,136,0.15); border-left-color: var(--primary-light); color: #fff; font-weight: 500; }
.nav-item .icon { font-size: 1.1rem; width: 20px; text-align: center; }
.nav-section { font-size: 0.7rem; color: #52B788; letter-spacing: 1px; padding: 14px 24px 4px; text-transform: uppercase; }

/* â”€â”€ MAIN â”€â”€ */
.main-content { flex: 1; padding: 28px; overflow-x: hidden; }
.page { display: none; }
.page.active { display: block; animation: fadeIn 0.25s; }
@keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:none; } }

/* â”€â”€ CARDS â”€â”€ */
.card {
  background: var(--surface); border-radius: var(--radius);
  box-shadow: var(--shadow); padding: 24px; margin-bottom: 20px;
  border: 1px solid var(--border);
}
.card-title { font-size: 1.1rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

/* â”€â”€ STATS â”€â”€ */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 20px; }
.stat-card {
  background: var(--surface); border-radius: var(--radius); padding: 20px;
  border: 1px solid var(--border); box-shadow: var(--shadow);
  display: flex; flex-direction: column; gap: 6px;
}
.stat-label { font-size: 0.78rem; color: var(--text-muted); }
.stat-value { font-size: 1.6rem; font-weight: 700; font-family: 'Gmarket Sans', sans-serif; color: var(--primary-dark); }
.stat-value.accent { color: var(--accent); }
.stat-value.green { color: var(--primary); }

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  border: none; border-radius: 10px; padding: 10px 20px;
  font-family: inherit; font-size: 0.9rem; font-weight: 500;
  cursor: pointer; transition: all 0.18s; white-space: nowrap;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
.btn-accent { background: var(--accent); color: #fff; }
.btn-accent:hover { background: #d4690a; }
.btn-outline { background: transparent; border: 1.5px solid var(--border); color: var(--text); }
.btn-outline:hover { border-color: var(--primary); color: var(--primary); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: #c0303b; }
.btn-sm { padding: 6px 12px; font-size: 0.82rem; border-radius: 7px; }
.btn-xs { padding: 4px 8px; font-size: 0.76rem; border-radius: 5px; }
.btn-success { background: var(--success); color: #fff; }
.btn-info { background: var(--info); color: #fff; }
.btn-warning { background: var(--warning); color: #fff; }

/* â”€â”€ FORMS â”€â”€ */
.form-group { margin-bottom: 16px; }
label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-muted); margin-bottom: 6px; }
input, select, textarea {
  width: 100%; border: 1.5px solid var(--border); border-radius: 10px;
  padding: 10px 14px; font-family: inherit; font-size: 0.92rem;
  background: var(--surface2); color: var(--text); transition: border-color 0.2s;
  outline: none;
}
input:focus, select:focus, textarea:focus { border-color: var(--primary-light); background: #fff; }
textarea { resize: vertical; min-height: 80px; }
.form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; }
.form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

/* â”€â”€ TABLES â”€â”€ */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
th { background: var(--primary-dark); color: #fff; padding: 10px 14px; text-align: left; font-weight: 500; white-space: nowrap; }
td { padding: 10px 14px; border-bottom: 1px solid var(--border); white-space: nowrap; }
tr:hover td { background: var(--surface2); }
.badge {
  display: inline-flex; align-items: center; padding: 3px 10px;
  border-radius: 12px; font-size: 0.78rem; font-weight: 600; white-space: nowrap;
}
.badge-pending { background: #FFF3CD; color: #856404; }
.badge-approved { background: #D1E7DD; color: #155724; }
.badge-rejected { background: #F8D7DA; color: #842029; }
.badge-cancelled { background: #E2E3E5; color: #41464B; }
.badge-mod-approved { background: #CCE5FF; color: #004085; }

/* â”€â”€ LOGIN PAGE â”€â”€ */
.login-page {
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  background: linear-gradient(135deg, var(--primary-dark) 0%, #1a4a2e 60%, #0f2d1a 100%);
  position: fixed; inset: 0; z-index: 200;
}
.login-box {
  background: #fff; border-radius: 24px; padding: 48px 40px; max-width: 420px; width: 90%;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4); text-align: center;
}
.login-logo { font-family: 'Gmarket Sans', sans-serif; font-size: 1.5rem; color: var(--primary); font-weight: 700; margin-bottom: 6px; }
.login-subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 32px; }
.sso-btn {
  width: 100%; padding: 14px; border: none; border-radius: 12px;
  font-family: inherit; font-size: 1rem; cursor: pointer; display: flex;
  align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px;
  font-weight: 500; transition: all 0.2s;
}
.sso-naver { background: #03C75A; color: #fff; }
.sso-naver:hover { background: #02a84a; }
.sso-google { background: #fff; color: #333; border: 2px solid #ddd; }
.sso-google:hover { border-color: #aaa; background: #f5f5f5; }
.login-divider { margin: 20px 0; color: var(--text-muted); font-size: 0.85rem; position: relative; }
.login-divider::before, .login-divider::after { content:''; position:absolute; top:50%; width:35%; height:1px; background: var(--border); }
.login-divider::before { left:0; } .login-divider::after { right:0; }
.admin-login-link { font-size: 0.82rem; color: var(--text-muted); cursor: pointer; margin-top: 12px; }
.admin-login-link:hover { color: var(--primary); }

/* â”€â”€ APPLICATION ENTRY â”€â”€ */
.app-entry {
  background: var(--surface2); border: 1.5px solid var(--border); border-radius: var(--radius);
  padding: 20px; margin-bottom: 16px; position: relative;
}
.app-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.app-entry-title { font-weight: 700; color: var(--primary-dark); font-size: 1rem; }

.participant-row {
  display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end; margin-bottom: 8px;
}
.participant-total { text-align: right; font-weight: 700; color: var(--primary); font-size: 0.95rem; margin-top: 8px; }

/* â”€â”€ OCR ZONE â”€â”€ */
.ocr-zone {
  border: 2px dashed var(--primary-light); border-radius: var(--radius);
  padding: 32px; text-align: center; cursor: pointer; transition: all 0.2s;
  background: rgba(82,183,136,0.04);
}
.ocr-zone:hover { border-color: var(--primary); background: rgba(82,183,136,0.08); }
.ocr-zone img { max-height: 120px; border-radius: 8px; margin-top: 12px; }

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  z-index: 500; align-items: center; justify-content: center;
  backdrop-filter: blur(3px);
}
.modal-overlay.open { display: flex; }
.modal {
  background: #fff; border-radius: 20px; padding: 32px; max-width: 560px; width: 92%;
  max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.modal-title { font-size: 1.15rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 20px; }

/* â”€â”€ TOAST â”€â”€ */
#toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast {
  background: var(--primary-dark); color: #fff; border-radius: 12px; padding: 12px 20px;
  font-size: 0.9rem; min-width: 220px; max-width: 340px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px;
}
.toast.success { background: var(--primary); }
.toast.error { background: var(--danger); }
.toast.warning { background: var(--warning); }
@keyframes slideIn { from { opacity:0; transform:translateX(20px); } to { opacity:1; transform:none; } }

/* â”€â”€ STATUS â”€â”€ */
.pending-indicator { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); display: inline-block; margin-right: 4px; animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{ opacity:1; } 50%{ opacity:0.4; } }

/* â”€â”€ CREDIT METER â”€â”€ */
.credit-bar-wrap { margin: 8px 0; }
.credit-bar-bg { background: var(--border); border-radius: 6px; height: 10px; overflow: hidden; }
.credit-bar-fill { height: 100%; border-radius: 6px; background: linear-gradient(90deg, var(--primary-light), var(--primary)); transition: width 0.4s; }

/* â”€â”€ RESPONSIVE â”€â”€ */
@media (max-width: 768px) {
  nav.sidebar { display: none; }
  .form-row { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: 1fr 1fr; }
  .participant-row { grid-template-columns: 1fr 1fr; }
  .participant-row .btn-xs { grid-column: 1/-1; justify-self: end; }
}

/* â”€â”€ MISC â”€â”€ */
.empty-state { text-align: center; padding: 48px 20px; color: var(--text-muted); }
.empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
.section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.page-title { font-family: 'Gmarket Sans', sans-serif; font-size: 1.4rem; font-weight: 700; color: var(--primary-dark); }
.text-muted { color: var(--text-muted); font-size: 0.85rem; }
.text-right { text-align: right; }
hr { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
.highlight-box { background: linear-gradient(135deg, rgba(247,127,0,0.08), rgba(252,191,73,0.08)); border: 1px solid rgba(247,127,0,0.2); border-radius: var(--radius-sm); padding: 12px 16px; }
.flex { display: flex; }
.flex-between { display: flex; justify-content: space-between; align-items: center; }
.gap-2 { gap: 8px; }
.mt-2 { margin-top: 8px; }
.mt-3 { margin-top: 16px; }
.mb-3 { margin-bottom: 16px; }
.w-full { width: 100%; }
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen">
  <div class="logo-big">ğŸ² ë³´ë™ë³´ë™</div>
  <div class="sub">ê°“ìƒì§€ì›ê¸ˆ ì‹ ì²­ ì‹œìŠ¤í…œ ë¡œë”© ì¤‘...</div>
  <div class="spinner"></div>
</div>

<!-- LOGIN PAGE -->
<div class="login-page" id="login-page" style="display:none;">
  <div class="login-box">
    <div style="font-size:3rem;margin-bottom:12px;">ğŸ²</div>
    <div class="login-logo">2026 ë³´ë™ë³´ë™<br>ê°“ìƒì§€ì›ê¸ˆ</div>
    <div class="login-subtitle">ë³´ë“œê²Œì„ & ë°©íƒˆì¶œ ì§€ì›ê¸ˆ ì‹ ì²­ í”Œë«í¼</div>


    <div class="login-box">
    <button class="sso-btn" onclick="loginSSO('kakao')" style="background: #FEE500; color: #000;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="black"><path d="M12 3c-4.97 0-9 3.185-9 7.115 0 2.558 1.707 4.8 4.34 6.111l-.85 3.11c-.046.17.07.338.24.338.08 0 .157-.03.21-.087l3.65-2.435c.46.065.93.1 1.41.1 4.97 0 9-3.185 9-7.115S16.97 3 12 3z"/></svg>
      ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ë¡œê·¸ì¸ / ê°€ì…
    </button>

    <button class="sso-btn sso-naver" onclick="loginSSO('naver')">
      ë„¤ì´ë²„ë¡œ ë¡œê·¸ì¸ / ê°€ì…
    </button>
    
    </div>
    <button class="sso-btn sso-naver" onclick="loginSSO('naver')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M16.273 12.845L7.376 0H0v24h7.727V11.155L16.624 24H24V0h-7.727z"/></svg>
      ë„¤ì´ë²„ë¡œ ë¡œê·¸ì¸ / ê°€ì…
    </button>
    <button class="sso-btn sso-google" onclick="loginSSO('google')">
      <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Googleë¡œ ë¡œê·¸ì¸ / ê°€ì…
    </button>

    <div class="login-divider">ë˜ëŠ”</div>
    <div class="admin-login-link" onclick="showAdminLogin()">ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</div>

    <div id="admin-login-form" style="display:none; margin-top:16px; text-align:left;">
      <div class="form-group">
        <label>ê´€ë¦¬ì ì•„ì´ë””</label>
        <input type="text" id="admin-id" placeholder="admin" value="admin">
      </div>
      <div class="form-group">
        <label>ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="admin-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" value="4321">
      </div>
      <button class="btn btn-primary w-full" onclick="adminLogin()">ê´€ë¦¬ì ë¡œê·¸ì¸</button>
    </div>

    <div id="sso-simulator" style="display:none; margin-top:16px; text-align:left;">
      <div style="background:#f0f4f0; border-radius:10px; padding:14px; margin-bottom:12px; font-size:0.83rem; color:#666;">
        ğŸ§ª <b>í…ŒìŠ¤íŠ¸ ëª¨ë“œ</b> â€” ì‹¤ì œ SSO ì—°ë™ ì‹œ API í‚¤ í•„ìš”<br>
        ì•„ë˜ì—ì„œ ê³„ì •ì„ ì„ íƒí•˜ì„¸ìš”
      </div>
      <div id="sso-provider-label" style="font-size:0.85rem; color:#888; margin-bottom:8px;"></div>
      <div id="sso-accounts"></div>
      <button class="btn btn-outline btn-sm mt-2" onclick="hideSSOSim()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none;">
  <header>
    <div class="header-logo" onclick="navigateTo('dashboard')">
      ğŸ² ë³´ë™ë³´ë™ ê°“ìƒì§€ì›ê¸ˆ
      <span>2026 ë³´ë“œê²Œì„ ì§€ì›ê¸ˆ ì‹ ì²­ ì‹œìŠ¤í…œ</span>
    </div>
    <div class="header-right">
      <div class="user-chip" id="header-user">
        <span id="header-username">-</span>
        <span class="credit-badge" id="header-credit">â‚©0</span>
      </div>
      <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </header>

  <div class="layout">
    <nav class="sidebar" id="sidebar">
      <!-- dynamically filled -->
    </nav>
    <div class="main-content">
      <!-- DASHBOARD -->
      <div class="page" id="page-dashboard">
        <div class="section-header">
          <div class="page-title">ğŸ“Š ëŒ€ì‹œë³´ë“œ</div>
        </div>
        <div class="stats-grid" id="dash-stats"></div>
        <div class="card">
          <div class="card-title">ğŸ“‹ ìµœê·¼ ì‹ ì²­ ë‚´ì—­</div>
          <div id="dash-recent"></div>
        </div>
      </div>

      <!-- APPLY -->
      <div class="page" id="page-apply">
        <div class="section-header">
          <div class="page-title">âœï¸ ì§€ì›ê¸ˆ ì‹ ì²­</div>
          <button class="btn btn-accent" onclick="addAppEntry()">+ ì‹ ì²­ í•­ëª© ì¶”ê°€</button>
        </div>
        <div class="card">
          <div class="card-title">ğŸ’° ë‚´ í¬ë ˆë”§ í˜„í™©</div>
          <div id="apply-credit-info"></div>
        </div>
        <div id="app-entries"></div>
        <div class="card">
          <div class="card-title">ğŸ¦ í™˜ê¸‰ ê³„ì¢Œ ì •ë³´</div>
          <div class="form-row">
            <div class="form-group">
              <label>ì˜ˆê¸ˆì£¼</label>
              <input type="text" id="apply-account-name" placeholder="ì˜ˆê¸ˆì£¼ ì„±í•¨">
            </div>
            <div class="form-group">
              <label>ì€í–‰ëª…</label>
              <select id="apply-bank">
                <option value="">ì„ íƒ</option>
                <option>êµ­ë¯¼ì€í–‰</option><option>ì‹ í•œì€í–‰</option><option>ìš°ë¦¬ì€í–‰</option>
                <option>í•˜ë‚˜ì€í–‰</option><option>ë†í˜‘ì€í–‰</option><option>ê¸°ì—…ì€í–‰</option>
                <option>ì¹´ì¹´ì˜¤ë±…í¬</option><option>í† ìŠ¤ë±…í¬</option><option>ì¼€ì´ë±…í¬</option>
                <option>SCì œì¼ì€í–‰</option><option>ì”¨í‹°ì€í–‰</option><option>ê¸°íƒ€</option>
              </select>
            </div>
            <div class="form-group">
              <label>ê³„ì¢Œë²ˆí˜¸</label>
              <input type="text" id="apply-account-num" placeholder="- ì—†ì´ ì…ë ¥">
            </div>
          </div>
          <div class="form-group">
            <label>ë¹„ê³ </label>
            <textarea id="apply-note" placeholder="ê¸°íƒ€ ì „ë‹¬ì‚¬í•­"></textarea>
          </div>
        </div>
        <div class="form-actions">
          <div id="apply-total-display" style="font-size:1rem; font-weight:700; color:var(--primary-dark); align-self:center;">ì´ ì‹ ì²­ê¸ˆì•¡: â‚©0</div>
          <button class="btn btn-outline" onclick="clearApply()">ì´ˆê¸°í™”</button>
          <button class="btn btn-primary" onclick="submitApplication()">ğŸ“¨ ì‹ ì²­ì„œ ì œì¶œ</button>
        </div>
      </div>

      <!-- MY APPLICATIONS -->
      <div class="page" id="page-my-apps">
        <div class="section-header">
          <div class="page-title">ğŸ“‹ ë‚´ ì‹ ì²­ ë‚´ì—­</div>
          <button class="btn btn-primary btn-sm" onclick="refreshMyApps()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="card">
          <div class="table-wrap" id="my-apps-table"></div>
        </div>
      </div>

      <!-- ADMIN: DASHBOARD -->
      <div class="page" id="page-admin-dash">
        <div class="section-header"><div class="page-title">ğŸ›¡ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</div></div>
        <div class="stats-grid" id="admin-stats"></div>
        <div class="card">
          <div class="card-title">â³ ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ <span class="pending-indicator"></span></div>
          <div id="admin-pending-list"></div>
        </div>
      </div>

      <!-- ADMIN: ALL APPLICATIONS -->
      <div class="page" id="page-admin-apps">
        <div class="section-header">
          <div class="page-title">ğŸ“‚ ì „ì²´ ì‹ ì²­ ë‚´ì—­ ì·¨í•©</div>
          <div class="flex gap-2">
            <input type="text" id="admin-search" placeholder="ê²€ìƒ‰..." style="width:200px" oninput="renderAdminApps()">
            <select id="admin-filter-status" onchange="renderAdminApps()" style="width:130px">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="pending">ëŒ€ê¸°</option>
              <option value="approved">ìŠ¹ì¸</option>
              <option value="rejected">ë°˜ë ¤</option>
              <option value="cancelled">ì·¨ì†Œ</option>
            </select>
            <button class="btn btn-outline btn-sm" onclick="exportCSV()">ğŸ“¥ CSV ë‚´ë³´ë‚´ê¸°</button>
          </div>
        </div>
        <div class="card"><div class="table-wrap" id="admin-apps-table"></div></div>
      </div>

      <!-- ADMIN: MEMBERS -->
      <div class="page" id="page-admin-members">
        <div class="section-header">
          <div class="page-title">ğŸ‘¥ íšŒì› ê´€ë¦¬</div>
          <button class="btn btn-accent" onclick="openCreateUserModal()">+ ê³„ì • ìƒì„±</button>
        </div>
        <div class="card"><div class="table-wrap" id="admin-members-table"></div></div>
      </div>

      <!-- ADMIN: LOGS -->
      <div class="page" id="page-admin-logs">
        <div class="section-header">
          <div class="page-title">ğŸ“œ ì‹œìŠ¤í…œ ë¡œê·¸</div>
          <button class="btn btn-outline btn-sm" onclick="clearLogs()">ğŸ—‘ï¸ ë¡œê·¸ ì´ˆê¸°í™”</button>
        </div>
        <div class="card"><div id="logs-list"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<!-- Application Detail Modal -->
<div class="modal-overlay" id="modal-app-detail">
  <div class="modal">
    <div class="modal-title" id="modal-app-title">ì‹ ì²­ ìƒì„¸</div>
    <div id="modal-app-content"></div>
    <div class="form-actions" id="modal-app-actions"></div>
  </div>
</div>

<!-- Admin Edit Modal -->
<div class="modal-overlay" id="modal-admin-edit">
  <div class="modal">
    <div class="modal-title">âœï¸ ì‹ ì²­ ë‚´ì—­ ìˆ˜ì • (ê´€ë¦¬ì)</div>
    <div id="modal-admin-edit-content"></div>
    <div class="form-actions" id="modal-admin-edit-actions"></div>
  </div>
</div>

<!-- Create User Modal -->
<div class="modal-overlay" id="modal-create-user">
  <div class="modal">
    <div class="modal-title">â• ê³„ì • ìƒì„±</div>
    <div class="form-group">
      <label>ì´ë¦„</label>
      <input type="text" id="new-user-name" placeholder="í™ê¸¸ë™">
    </div>
    <div class="form-group">
      <label>ì´ë©”ì¼ (ì•„ì´ë””)</label>
      <input type="email" id="new-user-email" placeholder="user@example.com">
    </div>
    <div class="form-group">
      <label>ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="new-user-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" value="4321">
    </div>
    <div class="form-group">
      <label>ì´ˆê¸° í¬ë ˆë”§ (ì›)</label>
      <input type="number" id="new-user-credit" value="30000">
    </div>
    <div class="form-group">
      <label>ì—­í• </label>
      <select id="new-user-role">
        <option value="user">ì¼ë°˜ íšŒì›</option>
        <option value="admin">ê´€ë¦¬ì</option>
      </select>
    </div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-create-user')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="createUser()">ê³„ì • ìƒì„±</button>
    </div>
  </div>
</div>

<!-- Credit Edit Modal -->
<div class="modal-overlay" id="modal-credit-edit">
  <div class="modal">
    <div class="modal-title">ğŸ’° í¬ë ˆë”§ ìˆ˜ì •</div>
    <div id="credit-edit-content"></div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeModal('modal-credit-edit')">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="saveCreditEdit()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<script>
// 2. Supabase ì—°ê²° ì„¤ì • (Supabase ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸ ê°€ëŠ¥)
const SUPABASE_URL = 'https://vkznarlbevlyqnspmnlj.supabase.co'; // ë‚´ í”„ë¡œì íŠ¸ URL
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrem5hcmxiZXZseXFuc3BtbmxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2OTg5MTcsImV4cCI6MjA4NzI3NDkxN30.Gm_GJJoiWJU4fvtfUhK4Ci-8CP3dJjW1KWzSazhKoJA'; // ë‚´ í”„ë¡œì íŠ¸ API í‚¤
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA STORE (localStorage-based)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
const DB = {
  get(key) { try { return JSON.parse(localStorage.getItem('bgapp_'+key)) || null; } catch { return null; } },
  set(key, val) { localStorage.setItem('bgapp_'+key, JSON.stringify(val)); },
  getUsers() { return this.get('users') || []; },
  getApps() { return this.get('applications') || []; },
  getLogs() { return this.get('logs') || []; },
  saveUsers(u) { this.set('users', u); },
  saveApps(a) { this.set('applications', a); },
  addLog(msg, userId) {
    const logs = this.getLogs();
    logs.unshift({ id: Date.now(), ts: new Date().toISOString(), msg, userId: userId||'system' });
    if (logs.length > 500) logs.pop();
    this.set('logs', logs);
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INITIAL SEED DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function seedData() {
  if (DB.get('seeded')) return;

  const users = [
    {
      id: 'admin',
      email: 'admin',
      name: 'ê´€ë¦¬ì',
      role: 'admin',
      status: 'approved',
      provider: 'local',
      password: '4321',
      creditTotal: 0,
      creditUsed: 0,
      creditPending: 0,
      createdAt: new Date().toISOString()
    },
    {
      id: 'u_test1',
      email: '__sso@naver.com',
      name: 'í…ŒìŠ¤íŠ¸ìœ ì €1',
      role: 'user',
      status: 'approved',
      provider: 'naver',
      password: '4321',
      creditTotal: 30000,
      creditUsed: 0,
      creditPending: 0,
      createdAt: new Date().toISOString()
    },
    {
      id: 'u_test2',
      email: '__sso1@naver.com',
      name: 'í…ŒìŠ¤íŠ¸ìœ ì €2',
      role: 'user',
      status: 'approved',
      provider: 'naver',
      password: '4321',
      creditTotal: 30000,
      creditUsed: 0,
      creditPending: 0,
      createdAt: new Date().toISOString()
    }
  ];
  DB.saveUsers(users);
  DB.set('seeded', true);
  DB.addLog('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ â€” ê¸°ë³¸ ê³„ì • ìƒì„±ë¨');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentUser = null;

// ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹¤í–‰ í•¨ìˆ˜
async function loginWithKakao() {
  const { data, error } = await supabaseClient.auth.signInWithOAuth({
    provider: 'kakao',
    options: {
      redirectTo: window.location.origin
    }
  });
  
  if (error) {
    console.error('ë¡œê·¸ì¸ ì—ëŸ¬:', error.message);
    showToast('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// ì´ í•¨ìˆ˜ë¥¼ í†µì§¸ë¡œ ë®ì–´ì“°ì„¸ìš”
function loginSSO(provider) {
  if (provider === 'kakao') {
    loginWithKakao();
    return; // ì¹´ì¹´ì˜¤ëŠ” ì—¬ê¸°ì„œ ì¢…ë£Œ
  }
}
  // ë„¤ì´ë²„, êµ¬ê¸€ìš© ì‹œë®¬ë ˆì´í„° ë¡œì§ ì‹œì‘
  const div = document.getElementById('sso-accounts');
  div.innerHTML = '';
  const label = provider === 'naver' ? 'ë„¤ì´ë²„ ê³„ì •' : 'Google ê³„ì •';
  document.getElementById('sso-provider-label').textContent = `${label} ì„ íƒ:`;

  const accounts = [];
  if (provider === 'naver') {
    accounts.push({ email: '__sso@naver.com', name: 'í…ŒìŠ¤íŠ¸ìœ ì €1' });
    accounts.push({ email: '__sso1@naver.com', name: 'í…ŒìŠ¤íŠ¸ìœ ì €2' });
    DB.getUsers().filter(u=>u.provider==='naver' && !['__sso@naver.com','__sso1@naver.com'].includes(u.email)).forEach(u=>accounts.push({email:u.email,name:u.name}));
  } else {
    DB.getUsers().filter(u=>u.provider==='google').forEach(u=>accounts.push({email:u.email,name:u.name}));
    accounts.push({ email: 'new_google@gmail.com', name: 'ìƒˆ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ê°€ì…' });
  }

  div.innerHTML = `<div style="margin-bottom:8px;">
    <input type="email" id="sso-email-input" placeholder="ì´ë©”ì¼ ì§ì ‘ ì…ë ¥" style="margin-bottom:6px;">
    <input type="password" id="sso-pw-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (ê¸°ë³¸: 4321)" value="4321" style="margin-bottom:8px;">
    <button class="btn btn-primary w-full btn-sm" onclick="doSSOLogin('${provider}')">ë¡œê·¸ì¸ / ê°€ì…</button>
  </div>
  <div style="font-size:0.8rem;color:#999;margin:8px 0;">â€”â€” ë˜ëŠ” ê¸°ì¡´ ê³„ì • ì„ íƒ â€”â€”</div>`;

  accounts.forEach(a => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline w-full btn-sm';
    btn.style.marginBottom = '6px';
    btn.textContent = `${a.name} (${a.email})`;
    btn.onclick = () => {
      document.getElementById('sso-email-input').value = a.email;
    };
    div.appendChild(btn);
  });

  document.getElementById('sso-simulator').style.display = 'block';
  document.getElementById('admin-login-form').style.display = 'none';
}

  // Build account list for this provider
  const accounts = [];
  if (provider === 'naver') {
    accounts.push({ email: '__sso@naver.com', name: 'í…ŒìŠ¤íŠ¸ìœ ì €1' });
    accounts.push({ email: '__sso1@naver.com', name: 'í…ŒìŠ¤íŠ¸ìœ ì €2' });
    // any approved user with naver
    DB.getUsers().filter(u=>u.provider==='naver' && !['__sso@naver.com','__sso1@naver.com'].includes(u.email)).forEach(u=>accounts.push({email:u.email,name:u.name}));
  } else {
    // google â€” show existing google users or allow new registration
    DB.getUsers().filter(u=>u.provider==='google').forEach(u=>accounts.push({email:u.email,name:u.name}));
    accounts.push({ email: 'new_google@gmail.com', name: 'ìƒˆ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ê°€ì…' });
  }

  // show input + accounts
  div.innerHTML = `<div style="margin-bottom:8px;">
    <input type="email" id="sso-email-input" placeholder="ì´ë©”ì¼ ì§ì ‘ ì…ë ¥" style="margin-bottom:6px;">
    <input type="password" id="sso-pw-input" placeholder="ë¹„ë°€ë²ˆí˜¸ (ê¸°ë³¸: 4321)" value="4321" style="margin-bottom:8px;">
    <button class="btn btn-primary w-full btn-sm" onclick="doSSOLogin('${provider}')">ë¡œê·¸ì¸ / ê°€ì…</button>
  </div>
  <div style="font-size:0.8rem;color:#999;margin:8px 0;">â€”â€” ë˜ëŠ” ê¸°ì¡´ ê³„ì • ì„ íƒ â€”â€”</div>`;

  accounts.forEach(a => {
    const btn = document.createElement('button');
    btn.className = 'btn btn-outline w-full btn-sm';
    btn.style.marginBottom = '6px';
    btn.textContent = `${a.name} (${a.email})`;
    btn.onclick = () => {
      document.getElementById('sso-email-input').value = a.email;
    };
    div.appendChild(btn);
  });

  document.getElementById('sso-simulator').style.display = 'block';
  document.getElementById('admin-login-form').style.display = 'none';
}

function doSSOLogin(provider) {
  const email = document.getElementById('sso-email-input').value.trim();
  const pw = document.getElementById('sso-pw-input').value;
  if (!email) { showToast('ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

  let users = DB.getUsers();
  let user = users.find(u => u.email === email);

  if (user) {
    // existing â€” check password
    if (user.password && user.password !== pw) { showToast('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤', 'error'); return; }
    if (user.status === 'pending') { showToast('ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤', 'warning'); return; }
    if (user.status === 'rejected') { showToast('ê°€ì…ì´ ê±°ì ˆëœ ê³„ì •ì…ë‹ˆë‹¤', 'error'); return; }
    doLogin(user);
  } else {
    // register new
    const newUser = {
      id: 'u_' + Date.now(),
      email,
      name: email.split('@')[0],
      role: 'user',
      status: 'pending',
      provider,
      password: pw || '4321',
      creditTotal: 0,
      creditUsed: 0,
      creditPending: 0,
      createdAt: new Date().toISOString()
    };
    users.push(newUser);
    DB.saveUsers(users);
    DB.addLog(`ì‹ ê·œ ê°€ì… ì‹ ì²­: ${email}`, newUser.id);
    showToast('ê°€ì… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'warning');
    hideSSOSim();
  }
}

function showAdminLogin() {
  document.getElementById('admin-login-form').style.display = 'block';
  document.getElementById('sso-simulator').style.display = 'none';
}

function hideSSOSim() {
  document.getElementById('sso-simulator').style.display = 'none';
}

function adminLogin() {
  const id = document.getElementById('admin-id').value;
  const pw = document.getElementById('admin-pw').value;
  const users = DB.getUsers();
  const user = users.find(u => (u.email === id || u.id === id) && u.password === pw && u.role === 'admin');
  if (user) { doLogin(user); }
  else { showToast('ê´€ë¦¬ì ì •ë³´ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤', 'error'); }
}

function doLogin(user) {
  currentUser = user;
  DB.set('session', user.id);
  DB.addLog(`ë¡œê·¸ì¸: ${user.name} (${user.email})`, user.id);
  document.getElementById('login-page').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  initApp();
  showToast(`ì•ˆë…•í•˜ì„¸ìš”, ${user.name}ë‹˜! ğŸ²`, 'success');
}

function logout() {
  if (currentUser) DB.addLog(`ë¡œê·¸ì•„ì›ƒ: ${currentUser.name}`, currentUser.id);
  currentUser = null;
  DB.set('session', null);
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-page').style.display = 'flex';
  hideSSOSim();
  document.getElementById('admin-login-form').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function initApp() {
  refreshCurrentUser();
  buildSidebar();
  navigateTo(currentUser.role === 'admin' ? 'admin-dash' : 'dashboard');
}

function refreshCurrentUser() {
  const users = DB.getUsers();
  const u = users.find(u => u.id === currentUser.id);
  if (u) currentUser = u;
  document.getElementById('header-username').textContent = currentUser.name;
  const avail = currentUser.creditTotal - currentUser.creditUsed - currentUser.creditPending;
  document.getElementById('header-credit').textContent = 'â‚©' + fmt(Math.max(0, avail));
}

function buildSidebar() {
  const sidebar = document.getElementById('sidebar');
  const isAdmin = currentUser.role === 'admin';
  const items = isAdmin ? [
    { id: 'admin-dash', icon: 'ğŸ“Š', label: 'ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ' },
    { id: 'admin-apps', icon: 'ğŸ“‚', label: 'ì „ì²´ ì‹ ì²­ ì·¨í•©' },
    { id: 'admin-members', icon: 'ğŸ‘¥', label: 'íšŒì› ê´€ë¦¬' },
    { id: 'admin-logs', icon: 'ğŸ“œ', label: 'ì‹œìŠ¤í…œ ë¡œê·¸' },
  ] : [
    { id: 'dashboard', icon: 'ğŸ ', label: 'ëŒ€ì‹œë³´ë“œ' },
    { id: 'apply', icon: 'âœï¸', label: 'ì§€ì›ê¸ˆ ì‹ ì²­' },
    { id: 'my-apps', icon: 'ğŸ“‹', label: 'ë‚´ ì‹ ì²­ ë‚´ì—­' },
  ];

  sidebar.innerHTML = items.map(i => `
    <div class="nav-item" id="nav-${i.id}" onclick="navigateTo('${i.id}')">
      <span class="icon">${i.icon}</span>${i.label}
    </div>
  `).join('');
}

function navigateTo(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const p = document.getElementById('page-'+page);
  if (p) p.classList.add('active');
  const n = document.getElementById('nav-'+page);
  if (n) n.classList.add('active');

  // Render page content
  switch (page) {
    case 'dashboard': renderDashboard(); break;
    case 'apply': initApply(); break;
    case 'my-apps': renderMyApps(); break;
    case 'admin-dash': renderAdminDash(); break;
    case 'admin-apps': renderAdminApps(); break;
    case 'admin-members': renderAdminMembers(); break;
    case 'admin-logs': renderLogs(); break;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderDashboard() {
  refreshCurrentUser();
  const u = currentUser;
  const avail = Math.max(0, u.creditTotal - u.creditUsed - u.creditPending);
  const pct = u.creditTotal > 0 ? ((u.creditUsed + u.creditPending) / u.creditTotal * 100).toFixed(0) : 0;

  document.getElementById('dash-stats').innerHTML = `
    <div class="stat-card">
      <div class="stat-label">ì´ ë³´ìœ  í¬ë ˆë”§</div>
      <div class="stat-value green">â‚©${fmt(u.creditTotal)}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ì‚¬ìš© ê°€ëŠ¥ í¬ë ˆë”§</div>
      <div class="stat-value accent">â‚©${fmt(avail)}</div>
      <div class="credit-bar-wrap">
        <div class="credit-bar-bg"><div class="credit-bar-fill" style="width:${pct}%"></div></div>
      </div>
      <div class="text-muted">ì‚¬ìš©+ëŒ€ê¸°: â‚©${fmt(u.creditUsed+u.creditPending)} / ${pct}%</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ìŠ¹ì¸ ì™„ë£Œ</div>
      <div class="stat-value">â‚©${fmt(u.creditUsed)}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</div>
      <div class="stat-value" style="color:var(--warning)">â‚©${fmt(u.creditPending)}</div>
    </div>
  `;

  const myApps = DB.getApps().filter(a => a.applicantId === u.id).slice(0, 5);
  if (myApps.length === 0) {
    document.getElementById('dash-recent').innerHTML = `<div class="empty-state"><div class="icon">ğŸ“­</div><p>ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p><button class="btn btn-accent mt-2" onclick="navigateTo('apply')">ì§€ê¸ˆ ì‹ ì²­í•˜ê¸°</button></div>`;
  } else {
    document.getElementById('dash-recent').innerHTML = `<div class="table-wrap">${buildAppsTable(myApps, false)}</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APPLICATION FORM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let appEntries = [];

function initApply() {
  refreshCurrentUser();
  const u = currentUser;
  const avail = Math.max(0, u.creditTotal - u.creditUsed - u.creditPending);
  document.getElementById('apply-credit-info').innerHTML = `
    <div class="flex-between mb-3">
      <div>
        <div class="stat-label">ì‚¬ìš© ê°€ëŠ¥ í¬ë ˆë”§</div>
        <div style="font-size:1.6rem;font-weight:700;color:var(--accent);">â‚©${fmt(avail)}</div>
      </div>
      <div class="text-muted">ì´ â‚©${fmt(u.creditTotal)} ì¤‘ â‚©${fmt(u.creditUsed+u.creditPending)} ì‚¬ìš©/ëŒ€ê¸°</div>
    </div>
    <div class="credit-bar-wrap"><div class="credit-bar-bg"><div class="credit-bar-fill" style="width:${Math.min(100,(u.creditUsed+u.creditPending)/Math.max(1,u.creditTotal)*100)}%"></div></div></div>
  `;

  if (appEntries.length === 0) addAppEntry();
  renderAppEntries();
}

function addAppEntry() {
  const users = DB.getUsers().filter(u => u.role === 'user' && u.status === 'approved');
  appEntries.push({
    id: Date.now(),
    date: new Date().toISOString().split('T')[0],
    category: '',
    description: '',
    receipt: null,
    receiptDataUrl: null,
    participants: [
      { userId: currentUser.id, name: currentUser.name, amount: '' }
    ]
  });
  renderAppEntries();
}

function removeAppEntry(idx) {
  appEntries.splice(idx, 1);
  if (appEntries.length === 0) addAppEntry();
  else renderAppEntries();
}

function addParticipant(entryIdx) {
  const users = DB.getUsers().filter(u => u.role === 'user' && u.status === 'approved' && u.id !== currentUser.id);
  appEntries[entryIdx].participants.push({ userId: '', name: '', amount: '' });
  renderAppEntries();
}

function removeParticipant(entryIdx, partIdx) {
  appEntries[entryIdx].participants.splice(partIdx, 1);
  renderAppEntries();
}

function renderAppEntries() {
  const users = DB.getUsers().filter(u => u.role === 'user' && u.status === 'approved');
  const container = document.getElementById('app-entries');
  container.innerHTML = '';

  appEntries.forEach((entry, idx) => {
    const total = entry.participants.reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
    const div = document.createElement('div');
    div.className = 'app-entry';

    const participantRows = entry.participants.map((p, pi) => {
      const isSelf = pi === 0;
      const userSelect = isSelf
        ? `<input type="text" value="${p.name}" disabled style="background:#eee;">`
        : `<select onchange="updateParticipant(${idx},${pi},'userId',this.value)">
            <option value="">íšŒì› ì„ íƒ</option>
            ${users.filter(u=>u.id!==currentUser.id).map(u=>`<option value="${u.id}" ${p.userId===u.id?'selected':''}>${u.name} (${u.email})</option>`).join('')}
           </select>`;

      return `<div class="participant-row">
        <div>
          <label>${isSelf ? 'ë³¸ì¸' : 'ê³µë™ì´ìš©ì'}</label>
          ${userSelect}
        </div>
        <div>
          <label>ì‹ ì²­ê¸ˆì•¡ (ì›)</label>
          <input type="number" value="${p.amount}" placeholder="0" onchange="updateParticipant(${idx},${pi},'amount',this.value)" oninput="updateParticipant(${idx},${pi},'amount',this.value)">
        </div>
        <div>
          ${!isSelf ? `<button class="btn btn-danger btn-xs" onclick="removeParticipant(${idx},${pi})">âœ•</button>` : ''}
        </div>
      </div>`;
    }).join('');

    div.innerHTML = `
      <div class="app-entry-header">
        <div class="app-entry-title">ğŸ“„ ì‹ ì²­ #${idx+1}</div>
        <div class="flex gap-2">
          <button class="btn btn-outline btn-sm" onclick="addParticipant(${idx})">ğŸ‘¥ ê³µë™ì´ìš©ì ì¶”ê°€</button>
          ${appEntries.length > 1 ? `<button class="btn btn-danger btn-sm" onclick="removeAppEntry(${idx})">ì‚­ì œ</button>` : ''}
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>ì¼ì</label>
          <input type="date" value="${entry.date}" onchange="updateEntry(${idx},'date',this.value)">
        </div>
        <div class="form-group">
          <label>ì‹ ì²­êµ¬ë¶„</label>
          <select onchange="updateEntry(${idx},'category',this.value)">
            <option value="" ${!entry.category?'selected':''}>ì„ íƒ</option>
            <option value="boardgame" ${entry.category==='boardgame'?'selected':''}>ë³´ë“œê²Œì„</option>
            <option value="escape" ${entry.category==='escape'?'selected':''}>ë°©íƒˆì¶œ</option>
            <option value="etc" ${entry.category==='etc'?'selected':''}>ê¸°íƒ€</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>ì´ìš©ë‚´ìš©</label>
        <input type="text" value="${entry.description}" placeholder="ì´ìš© ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" onchange="updateEntry(${idx},'description',this.value)">
      </div>
      <div style="margin-bottom:12px;">
        <label style="display:block;margin-bottom:6px;font-size:0.85rem;font-weight:500;color:var(--text-muted);">ì°¸ê°€ì ë° ì‹ ì²­ê¸ˆì•¡</label>
        ${participantRows}
        <div class="participant-total">í•©ê³„: â‚©${fmt(total)}</div>
      </div>
      <div class="form-group">
        <label>ì˜ìˆ˜ì¦ ì²¨ë¶€</label>
        <div class="ocr-zone" onclick="triggerFileInput(${idx})">
          ${entry.receiptDataUrl
            ? `<img src="${entry.receiptDataUrl}" alt="ì˜ìˆ˜ì¦"><div style="margin-top:8px;font-size:0.82rem;color:var(--text-muted);">í´ë¦­í•˜ì—¬ ë³€ê²½ | <span style="color:var(--primary)">OCR ë¶„ì„ ì™„ë£Œ</span></div>`
            : `<div>ğŸ“ ì˜ìˆ˜ì¦ ì‚¬ì§„ì„ í´ë¦­í•˜ì—¬ ì²¨ë¶€<br><small style="color:var(--text-muted)">JPG, PNG, PDF ì§€ì› | OCR ìë™ ì¸ì‹</small></div>`}
          <input type="file" accept="image/*,application/pdf" style="display:none" id="file-${idx}" onchange="handleFile(${idx},this)">
        </div>
        ${entry.ocrResult ? `<div class="highlight-box mt-2"><b>ğŸ¤– OCR ì¸ì‹ ê²°ê³¼:</b><br>${entry.ocrResult}</div>` : ''}
      </div>
    `;
    container.appendChild(div);
  });

  updateTotalDisplay();
}

function updateEntry(idx, field, val) {
  appEntries[idx][field] = val;
  if (field !== 'date' && field !== 'description') renderAppEntries();
  else updateTotalDisplay();
}

function updateParticipant(entryIdx, partIdx, field, val) {
  if (field === 'userId') {
    const users = DB.getUsers();
    const u = users.find(u => u.id === val);
    appEntries[entryIdx].participants[partIdx].userId = val;
    appEntries[entryIdx].participants[partIdx].name = u ? u.name : '';
  } else {
    appEntries[entryIdx].participants[partIdx][field] = val;
  }
  // re-render only totals
  updateTotalDisplay();
  // update total in entry
  const totalEl = document.querySelectorAll('.participant-total')[entryIdx];
  if (totalEl) {
    const total = appEntries[entryIdx].participants.reduce((s,p)=>s+(parseFloat(p.amount)||0),0);
    totalEl.textContent = 'í•©ê³„: â‚©' + fmt(total);
  }
}

function updateTotalDisplay() {
  const total = appEntries.reduce((s, e) =>
    s + e.participants.reduce((ss, p) => ss + (parseFloat(p.amount)||0), 0), 0);
  document.getElementById('apply-total-display').textContent = 'ì´ ì‹ ì²­ê¸ˆì•¡: â‚©' + fmt(total);
}

function triggerFileInput(idx) {
  document.getElementById('file-'+idx).click();
}

function handleFile(idx, input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    appEntries[idx].receiptDataUrl = e.target.result;
    appEntries[idx].receipt = file.name;
    // Simulate OCR
    simulateOCR(idx, file.name);
    renderAppEntries();
  };
  reader.readAsDataURL(file);
}

function simulateOCR(idx, filename) {
  // Simulate OCR extraction
  const simulatedData = [
    'ê°€ë§¹ì : ë³´ë“œê²Œì„ì¹´í˜ ë‚˜ë¹„íš¨ê³¼\në‚ ì§œ: ' + new Date().toLocaleDateString() + '\nê¸ˆì•¡: 18,000ì›\ní’ˆëª©: ë³´ë“œê²Œì„ 2ì¸ ì…ì¥',
    'ê°€ë§¹ì : ì´ìŠ¤ì¼€ì´í”„ ë£¸ ì„œìš¸\në‚ ì§œ: ' + new Date().toLocaleDateString() + '\nê¸ˆì•¡: 28,000ì›\ní’ˆëª©: ë°©íƒˆì¶œ 2ì¸',
    'ê°€ë§¹ì : ì£¼ì‚¬ìœ„ ì™•êµ­\në‚ ì§œ: ' + new Date().toLocaleDateString() + '\nê¸ˆì•¡: 12,000ì›\ní’ˆëª©: ë³´ë“œê²Œì„ ì¹´í˜ ì…ì¥ë£Œ',
  ];
  appEntries[idx].ocrResult = simulatedData[Math.floor(Math.random() * simulatedData.length)];
  showToast('ğŸ¤– OCR ì˜ìˆ˜ì¦ ë¶„ì„ ì™„ë£Œ!', 'success');
}

function clearApply() {
  appEntries = [];
  addAppEntry();
  document.getElementById('apply-account-name').value = '';
  document.getElementById('apply-bank').value = '';
  document.getElementById('apply-account-num').value = '';
  document.getElementById('apply-note').value = '';
}

function submitApplication() {
  // Validation
  for (let i = 0; i < appEntries.length; i++) {
    const e = appEntries[i];
    if (!e.date) { showToast(`ì‹ ì²­ #${i+1}: ì¼ìë¥¼ ì…ë ¥í•˜ì„¸ìš”`, 'error'); return; }
    if (!e.category) { showToast(`ì‹ ì²­ #${i+1}: ì‹ ì²­êµ¬ë¶„ì„ ì„ íƒí•˜ì„¸ìš”`, 'error'); return; }
    if (!e.description) { showToast(`ì‹ ì²­ #${i+1}: ì´ìš©ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”`, 'error'); return; }
    for (let j = 1; j < e.participants.length; j++) {
      if (!e.participants[j].userId) { showToast(`ì‹ ì²­ #${i+1}: ê³µë™ì´ìš©ì íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”`, 'error'); return; }
    }
  }

  const bank = document.getElementById('apply-bank').value;
  const accountName = document.getElementById('apply-account-name').value;
  const accountNum = document.getElementById('apply-account-num').value;

  if (!accountName || !bank || !accountNum) {
    showToast('í™˜ê¸‰ ê³„ì¢Œ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”', 'error'); return;
  }

  // Credit check
  const users = DB.getUsers();
  const avail = (u) => Math.max(0, u.creditTotal - u.creditUsed - u.creditPending);

  // Check each participant's credit
  for (let e of appEntries) {
    for (let p of e.participants) {
      const u = users.find(u => u.id === p.userId);
      if (!u) continue;
      const amt = parseFloat(p.amount) || 0;
      if (amt <= 0) continue;
      // Sum all amounts for this user across entries
      const totalForUser = appEntries.reduce((s, en) =>
        s + en.participants.filter(pp=>pp.userId===u.id).reduce((ss,pp)=>ss+(parseFloat(pp.amount)||0),0), 0);
      if (totalForUser > avail(u)) {
        showToast(`${u.name}ë‹˜ì˜ í¬ë ˆë”§ì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (ê°€ëŠ¥: â‚©${fmt(avail(u))})`, 'error');
        return;
      }
    }
  }

  // Create application record
  const app = {
    id: 'app_' + Date.now(),
    applicantId: currentUser.id,
    applicantName: currentUser.name,
    status: 'pending',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    bankName: bank,
    accountName,
    accountNum,
    note: document.getElementById('apply-note').value,
    entries: appEntries.map(e => ({
      ...e,
      totalAmount: e.participants.reduce((s,p)=>s+(parseFloat(p.amount)||0),0)
    })),
    totalAmount: appEntries.reduce((s,e)=>s+e.participants.reduce((ss,p)=>ss+(parseFloat(p.amount)||0),0),0)
  };

  // Deduct pending credits
  const updatedUsers = [...users];
  for (let e of appEntries) {
    for (let p of e.participants) {
      const amt = parseFloat(p.amount) || 0;
      if (amt <= 0 || !p.userId) continue;
      const uIdx = updatedUsers.findIndex(u => u.id === p.userId);
      if (uIdx !== -1) updatedUsers[uIdx].creditPending += amt;
    }
  }
  DB.saveUsers(updatedUsers);

  const apps = DB.getApps();
  apps.push(app);
  DB.saveApps(apps);
  DB.addLog(`ì‹ ì²­ ì œì¶œ: ${app.id} / ì´ â‚©${fmt(app.totalAmount)}`, currentUser.id);

  showToast('âœ… ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
  clearApply();
  refreshCurrentUser();
  navigateTo('my-apps');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MY APPLICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderMyApps() {
  refreshCurrentUser();
  const myApps = DB.getApps().filter(a => a.applicantId === currentUser.id)
    .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

  const container = document.getElementById('my-apps-table');
  if (myApps.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“­</div><p>ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>`;
    return;
  }

  container.innerHTML = buildAppsTable(myApps, true, false);
}

function refreshMyApps() { renderMyApps(); }

function buildAppsTable(apps, showDetail=true, isAdmin=false) {
  return `<table>
    <thead><tr>
      <th>ì‹ ì²­ì¼</th><th>ì‹ ì²­ì</th><th>í•­ëª©ìˆ˜</th><th>ì´ê¸ˆì•¡</th><th>ìƒíƒœ</th>
      ${showDetail ? '<th>ìƒì„¸</th>' : ''}
      ${isAdmin ? '<th>ê´€ë¦¬</th>' : ''}
    </tr></thead>
    <tbody>
    ${apps.map(a => `<tr>
      <td>${fmtDate(a.createdAt)}</td>
      <td>${a.applicantName}</td>
      <td>${a.entries ? a.entries.length : 0}ê±´</td>
      <td><b>â‚©${fmt(a.totalAmount)}</b></td>
      <td>${statusBadge(a.status)}</td>
      ${showDetail ? `<td>
        <button class="btn btn-outline btn-xs" onclick="openAppDetail('${a.id}',${isAdmin})">ìƒì„¸ë³´ê¸°</button>
        ${a.status === 'pending' ? `<button class="btn btn-danger btn-xs" onclick="cancelApp('${a.id}')">ì·¨ì†Œ</button>` : ''}
      </td>` : ''}
      ${isAdmin ? `<td>
        <button class="btn btn-success btn-xs" onclick="approveApp('${a.id}')">ìŠ¹ì¸</button>
        <button class="btn btn-warning btn-xs" onclick="openAdminEdit('${a.id}')">ìˆ˜ì •</button>
        <button class="btn btn-danger btn-xs" onclick="rejectApp('${a.id}')">ë°˜ë ¤</button>
      </td>` : ''}
    </tr>`).join('')}
    </tbody>
  </table>`;
}

function cancelApp(appId) {
  if (!confirm('ì‹ ì²­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const apps = DB.getApps();
  const idx = apps.findIndex(a => a.id === appId);
  if (idx === -1) return;
  const app = apps[idx];
  if (app.status !== 'pending') { showToast('ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ë§Œ ì·¨ì†Œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error'); return; }

  apps[idx].status = 'cancelled';
  apps[idx].updatedAt = new Date().toISOString();
  DB.saveApps(apps);

  // Restore pending credits
  restorePendingCredits(app);
  DB.addLog(`ì‹ ì²­ ì·¨ì†Œ: ${appId}`, currentUser.id);
  showToast('ì‹ ì²­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
  refreshCurrentUser();
  renderMyApps();
}

function restorePendingCredits(app) {
  const users = DB.getUsers();
  for (let e of (app.entries||[])) {
    for (let p of e.participants) {
      const amt = parseFloat(p.amount) || 0;
      if (amt <= 0 || !p.userId) continue;
      const uIdx = users.findIndex(u => u.id === p.userId);
      if (uIdx !== -1) users[uIdx].creditPending = Math.max(0, users[uIdx].creditPending - amt);
    }
  }
  DB.saveUsers(users);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openAppDetail(appId, isAdmin=false) {
  const app = DB.getApps().find(a => a.id === appId);
  if (!app) return;

  document.getElementById('modal-app-title').textContent = `ì‹ ì²­ ìƒì„¸ â€” ${fmtDate(app.createdAt)}`;

  const entriesHtml = (app.entries||[]).map((e,i) => `
    <div style="background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:12px;border:1px solid var(--border);">
      <div style="font-weight:700;margin-bottom:8px;">ğŸ“„ ì‹ ì²­ #${i+1} â€” ${catLabel(e.category)}</div>
      <div class="form-row" style="margin-bottom:8px;">
        <div><b>ì¼ì:</b> ${e.date}</div>
        <div><b>í•©ê³„:</b> â‚©${fmt(e.totalAmount)}</div>
      </div>
      <div><b>ì´ìš©ë‚´ìš©:</b> ${e.description}</div>
      <hr>
      ${(e.participants||[]).map(p=>`
        <div class="flex-between" style="margin:4px 0;">
          <span>${p.name || '(ë¯¸ì„ íƒ)'}</span>
          <span><b>â‚©${fmt(p.amount)}</b></span>
        </div>
      `).join('')}
      ${e.receiptDataUrl ? `<img src="${e.receiptDataUrl}" style="max-width:100%;border-radius:8px;margin-top:8px;">` : ''}
      ${e.ocrResult ? `<div class="highlight-box mt-2" style="font-size:0.82rem;"><b>OCR:</b><br>${e.ocrResult}</div>` : ''}
    </div>
  `).join('');

  document.getElementById('modal-app-content').innerHTML = `
    <div style="margin-bottom:12px;">
      <div class="flex-between mb-3">
        <div><b>ì‹ ì²­ì:</b> ${app.applicantName}</div>
        <div>${statusBadge(app.status)}</div>
      </div>
      <div><b>ê³„ì¢Œ:</b> ${app.bankName} ${app.accountNum} (${app.accountName})</div>
      ${app.note ? `<div><b>ë¹„ê³ :</b> ${app.note}</div>` : ''}
      ${app.adminNote ? `<div><b>ê´€ë¦¬ì ë©”ëª¨:</b> ${app.adminNote}</div>` : ''}
    </div>
    ${entriesHtml}
    <div class="flex-between" style="font-size:1.1rem;font-weight:700;color:var(--primary-dark);">
      <span>ì´ ì‹ ì²­ê¸ˆì•¡</span><span>â‚©${fmt(app.totalAmount)}</span>
    </div>
  `;

  document.getElementById('modal-app-actions').innerHTML = `
    <button class="btn btn-outline" onclick="closeModal('modal-app-detail')">ë‹«ê¸°</button>
  `;

  openModal('modal-app-detail');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderAdminDash() {
  const apps = DB.getApps();
  const users = DB.getUsers().filter(u=>u.role==='user');
  const pending = apps.filter(a=>a.status==='pending');
  const approved = apps.filter(a=>a.status==='approved'||a.status==='mod-approved');
  const totalApproved = approved.reduce((s,a)=>s+a.totalAmount,0);

  document.getElementById('admin-stats').innerHTML = `
    <div class="stat-card">
      <div class="stat-label">ì „ì²´ íšŒì›</div>
      <div class="stat-value">${users.length}ëª…</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸°</div>
      <div class="stat-value accent">${pending.length}ê±´</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ì „ì²´ ì‹ ì²­</div>
      <div class="stat-value">${apps.length}ê±´</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ì´ ì§€ê¸‰ ê¸ˆì•¡</div>
      <div class="stat-value green">â‚©${fmt(totalApproved)}</div>
    </div>
  `;

  const pendingList = document.getElementById('admin-pending-list');
  if (pending.length === 0) {
    pendingList.innerHTML = `<div class="empty-state"><div class="icon">âœ…</div><p>ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>`;
    return;
  }

  pendingList.innerHTML = `<div class="table-wrap">${buildAppsTable(pending.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)), true, true)}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN: ALL APPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderAdminApps() {
  let apps = DB.getApps();
  const search = (document.getElementById('admin-search')?.value||'').toLowerCase();
  const statusFilter = document.getElementById('admin-filter-status')?.value||'';

  if (search) apps = apps.filter(a =>
    a.applicantName.toLowerCase().includes(search) ||
    a.id.toLowerCase().includes(search) ||
    (a.note||'').toLowerCase().includes(search)
  );
  if (statusFilter) apps = apps.filter(a => a.status === statusFilter);

  apps.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

  const container = document.getElementById('admin-apps-table');
  if (apps.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ”</div><p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>`;
    return;
  }

  container.innerHTML = buildAppsTable(apps, true, true);
}

function approveApp(appId) {
  if (!confirm('ì´ ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const apps = DB.getApps();
  const idx = apps.findIndex(a => a.id === appId);
  if (idx === -1) return;
  const app = apps[idx];

  const prevStatus = app.status;
  apps[idx].status = prevStatus === 'pending' ? 'approved' : 'mod-approved';
  apps[idx].updatedAt = new Date().toISOString();
  apps[idx].approvedBy = currentUser.id;
  apps[idx].approvedAt = new Date().toISOString();
  DB.saveApps(apps);

  // Move pending -> used
  const users = DB.getUsers();
  for (let e of (app.entries||[])) {
    for (let p of e.participants) {
      const amt = parseFloat(p.amount)||0;
      if (amt<=0||!p.userId) continue;
      const uIdx = users.findIndex(u=>u.id===p.userId);
      if (uIdx!==-1) {
        users[uIdx].creditPending = Math.max(0, users[uIdx].creditPending - amt);
        users[uIdx].creditUsed += amt;
      }
    }
  }
  DB.saveUsers(users);
  DB.addLog(`ì‹ ì²­ ìŠ¹ì¸: ${appId} / â‚©${fmt(app.totalAmount)}`, currentUser.id);
  showToast('âœ… ìŠ¹ì¸ ì™„ë£Œ!', 'success');
  closeModal('modal-app-detail');
  renderAdminDash();
}

function rejectApp(appId) {
  if (!confirm('ì´ ì‹ ì²­ì„ ë°˜ë ¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  const apps = DB.getApps();
  const idx = apps.findIndex(a => a.id === appId);
  if (idx === -1) return;
  const app = apps[idx];

  apps[idx].status = 'rejected';
  apps[idx].updatedAt = new Date().toISOString();
  DB.saveApps(apps);

  // Restore pending credits
  restorePendingCredits(app);
  DB.addLog(`ì‹ ì²­ ë°˜ë ¤: ${appId}`, currentUser.id);
  showToast('ë°˜ë ¤ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'warning');
  closeModal('modal-app-detail');
  renderAdminDash();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN EDIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let editingAppId = null;

function openAdminEdit(appId) {
  editingAppId = appId;
  const app = DB.getApps().find(a => a.id === appId);
  if (!app) return;

  const content = document.getElementById('modal-admin-edit-content');
  const entriesHtml = (app.entries||[]).map((e,i) => `
    <div style="background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:12px;">
      <b>ì‹ ì²­ #${i+1}</b>
      <div class="form-row mt-2">
        <div class="form-group">
          <label>ì¼ì</label>
          <input type="date" id="edit-date-${i}" value="${e.date}">
        </div>
        <div class="form-group">
          <label>êµ¬ë¶„</label>
          <select id="edit-cat-${i}">
            <option value="boardgame" ${e.category==='boardgame'?'selected':''}>ë³´ë“œê²Œì„</option>
            <option value="escape" ${e.category==='escape'?'selected':''}>ë°©íƒˆì¶œ</option>
            <option value="etc" ${e.category==='etc'?'selected':''}>ê¸°íƒ€</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>ì´ìš©ë‚´ìš©</label>
        <input type="text" id="edit-desc-${i}" value="${e.description}">
      </div>
      ${(e.participants||[]).map((p,pi)=>`
        <div class="form-row">
          <div><label>${pi===0?'ë³¸ì¸':'ê³µë™ì´ìš©ì'}: ${p.name}</label></div>
          <div class="form-group">
            <label>ì‹ ì²­ê¸ˆì•¡</label>
            <input type="number" id="edit-amt-${i}-${pi}" value="${p.amount}">
          </div>
        </div>
      `).join('')}
    </div>
  `).join('');

  content.innerHTML = `
    <div class="form-group">
      <label>ì€í–‰</label>
      <input type="text" id="edit-bank" value="${app.bankName}">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>ì˜ˆê¸ˆì£¼</label>
        <input type="text" id="edit-acname" value="${app.accountName}">
      </div>
      <div class="form-group">
        <label>ê³„ì¢Œë²ˆí˜¸</label>
        <input type="text" id="edit-acnum" value="${app.accountNum}">
      </div>
    </div>
    <div class="form-group">
      <label>ê´€ë¦¬ì ë©”ëª¨</label>
      <textarea id="edit-admin-note">${app.adminNote||''}</textarea>
    </div>
    ${entriesHtml}
  `;

  document.getElementById('modal-admin-edit-actions').innerHTML = `
    <button class="btn btn-outline" onclick="closeModal('modal-admin-edit')">ì·¨ì†Œ</button>
    <button class="btn btn-warning" onclick="saveAdminEdit(false)">ìˆ˜ì • ì €ì¥</button>
    <button class="btn btn-success" onclick="saveAdminEdit(true)">ìˆ˜ì • í›„ ìŠ¹ì¸</button>
  `;

  openModal('modal-admin-edit');
}

function saveAdminEdit(andApprove) {
  const apps = DB.getApps();
  const idx = apps.findIndex(a => a.id === editingAppId);
  if (idx === -1) return;
  const app = apps[idx];
  const prevStatus = app.status;

  app.bankName = document.getElementById('edit-bank').value;
  app.accountName = document.getElementById('edit-acname').value;
  app.accountNum = document.getElementById('edit-acnum').value;
  app.adminNote = document.getElementById('edit-admin-note').value;

  let newTotal = 0;
  app.entries.forEach((e, i) => {
    e.date = document.getElementById(`edit-date-${i}`)?.value || e.date;
    e.category = document.getElementById(`edit-cat-${i}`)?.value || e.category;
    e.description = document.getElementById(`edit-desc-${i}`)?.value || e.description;
    e.participants.forEach((p, pi) => {
      const newAmt = parseFloat(document.getElementById(`edit-amt-${i}-${pi}`)?.value) || 0;
      // Update pending difference if still pending
      if (app.status === 'pending') {
        const diff = newAmt - (parseFloat(p.amount)||0);
        if (p.userId && diff !== 0) {
          const users = DB.getUsers();
          const uIdx = users.findIndex(u=>u.id===p.userId);
          if (uIdx !== -1) { users[uIdx].creditPending = Math.max(0, users[uIdx].creditPending + diff); DB.saveUsers(users); }
        }
      }
      p.amount = newAmt;
    });
    e.totalAmount = e.participants.reduce((s,p)=>s+(parseFloat(p.amount)||0),0);
    newTotal += e.totalAmount;
  });
  app.totalAmount = newTotal;

  if (andApprove) {
    app.status = 'mod-approved';
    app.approvedBy = currentUser.id;
    app.approvedAt = new Date().toISOString();
    // Move pending -> used
    const users = DB.getUsers();
    for (let e of app.entries) {
      for (let p of e.participants) {
        const amt = parseFloat(p.amount)||0;
        if (amt<=0||!p.userId) continue;
        const uIdx = users.findIndex(u=>u.id===p.userId);
        if (uIdx!==-1) {
          users[uIdx].creditPending = Math.max(0, users[uIdx].creditPending - amt);
          users[uIdx].creditUsed += amt;
        }
      }
    }
    DB.saveUsers(users);
  }

  app.updatedAt = new Date().toISOString();
  apps[idx] = app;
  DB.saveApps(apps);
  DB.addLog(`ì‹ ì²­ ìˆ˜ì •${andApprove?'+ìŠ¹ì¸':''}: ${editingAppId}`, currentUser.id);
  showToast(andApprove ? 'âœ… ìˆ˜ì • í›„ ìŠ¹ì¸ ì™„ë£Œ' : 'âœï¸ ìˆ˜ì • ì™„ë£Œ', 'success');
  closeModal('modal-admin-edit');
  renderAdminDash();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN MEMBERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderAdminMembers() {
  const users = DB.getUsers();
  const container = document.getElementById('admin-members-table');

  container.innerHTML = `<table>
    <thead><tr>
      <th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ê°€ì…ë°©ë²•</th><th>ìƒíƒœ</th>
      <th>ì´í¬ë ˆë”§</th><th>ì‚¬ìš©</th><th>ëŒ€ê¸°</th><th>ê°€ìš©</th><th>ê´€ë¦¬</th>
    </tr></thead>
    <tbody>
    ${users.map(u => {
      const avail = Math.max(0, u.creditTotal - u.creditUsed - u.creditPending);
      return `<tr>
        <td><b>${u.name}</b>${u.role==='admin'?'<span style="margin-left:4px;font-size:0.75rem;background:var(--primary-dark);color:#fff;border-radius:4px;padding:1px 5px;">ê´€ë¦¬ì</span>':''}</td>
        <td>${u.email}</td>
        <td>${u.provider||'local'}</td>
        <td>${u.status==='approved'?'<span style="color:var(--success);">âœ… ìŠ¹ì¸</span>':u.status==='pending'?'<span style="color:var(--warning);">â³ ëŒ€ê¸°</span>':'<span style="color:var(--danger);">âŒ ê±°ì ˆ</span>'}</td>
        <td>â‚©${fmt(u.creditTotal)}</td>
        <td>â‚©${fmt(u.creditUsed)}</td>
        <td>â‚©${fmt(u.creditPending)}</td>
        <td><b>â‚©${fmt(avail)}</b></td>
        <td>
          ${u.status==='pending'?`<button class="btn btn-success btn-xs" onclick="approveUser('${u.id}')">ìŠ¹ì¸</button>`:''}
          <button class="btn btn-info btn-xs" onclick="openCreditEdit('${u.id}')">í¬ë ˆë”§</button>
          ${u.status!=='rejected'&&u.role!=='admin'?`<button class="btn btn-danger btn-xs" onclick="rejectUser('${u.id}')">ê±°ì ˆ</button>`:''}
        </td>
      </tr>`;
    }).join('')}
    </tbody>
  </table>`;
}

function approveUser(userId) {
  const users = DB.getUsers();
  const idx = users.findIndex(u=>u.id===userId);
  if (idx===-1) return;
  users[idx].status = 'approved';
  users[idx].creditTotal = 30000; // grant initial credit
  DB.saveUsers(users);
  DB.addLog(`íšŒì› ìŠ¹ì¸ + í¬ë ˆë”§ â‚©30,000 ë¶€ì—¬: ${users[idx].email}`, currentUser.id);
  showToast(`${users[idx].name} ìŠ¹ì¸ ì™„ë£Œ! í¬ë ˆë”§ â‚©30,000 ì§€ê¸‰`, 'success');
  renderAdminMembers();
}

function rejectUser(userId) {
  const users = DB.getUsers();
  const idx = users.findIndex(u=>u.id===userId);
  if (idx===-1) return;
  if (!confirm(`${users[idx].name}ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  users[idx].status = 'rejected';
  DB.saveUsers(users);
  DB.addLog(`íšŒì› ê±°ì ˆ: ${users[idx].email}`, currentUser.id);
  showToast('ê±°ì ˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤', 'warning');
  renderAdminMembers();
}

let editingUserId = null;
function openCreditEdit(userId) {
  editingUserId = userId;
  const users = DB.getUsers();
  const u = users.find(u=>u.id===userId);
  if (!u) return;
  document.getElementById('credit-edit-content').innerHTML = `
    <div style="margin-bottom:14px;"><b>${u.name}</b> (${u.email})</div>
    <div class="form-group">
      <label>ì´ í¬ë ˆë”§ (ì›)</label>
      <input type="number" id="credit-total-input" value="${u.creditTotal}">
    </div>
    <div class="form-group">
      <label>ì‚¬ìš© í¬ë ˆë”§ (ì›) â€” ê´€ë¦¬ì ì¡°ì •ìš©</label>
      <input type="number" id="credit-used-input" value="${u.creditUsed}">
    </div>
    <div class="text-muted">ëŒ€ê¸° ì¤‘: â‚©${fmt(u.creditPending)} (ì‹ ì²­ ì·¨ì†Œ/ë°˜ë ¤ ì‹œ ìë™ ë³µêµ¬)</div>
  `;
  openModal('modal-credit-edit');
}

function saveCreditEdit() {
  const users = DB.getUsers();
  const idx = users.findIndex(u=>u.id===editingUserId);
  if (idx===-1) return;
  users[idx].creditTotal = parseFloat(document.getElementById('credit-total-input').value)||0;
  users[idx].creditUsed = parseFloat(document.getElementById('credit-used-input').value)||0;
  DB.saveUsers(users);
  DB.addLog(`í¬ë ˆë”§ ìˆ˜ì •: ${users[idx].email} â†’ ì´ â‚©${fmt(users[idx].creditTotal)}`, currentUser.id);
  showToast('í¬ë ˆë”§ ìˆ˜ì • ì™„ë£Œ', 'success');
  closeModal('modal-credit-edit');
  renderAdminMembers();
}

function openCreateUserModal() {
  document.getElementById('new-user-name').value = '';
  document.getElementById('new-user-email').value = '';
  document.getElementById('new-user-pw').value = '4321';
  document.getElementById('new-user-credit').value = '30000';
  document.getElementById('new-user-role').value = 'user';
  openModal('modal-create-user');
}

function createUser() {
  const name = document.getElementById('new-user-name').value.trim();
  const email = document.getElementById('new-user-email').value.trim();
  const pw = document.getElementById('new-user-pw').value;
  const credit = parseFloat(document.getElementById('new-user-credit').value)||0;
  const role = document.getElementById('new-user-role').value;

  if (!name||!email) { showToast('ì´ë¦„ê³¼ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

  const users = DB.getUsers();
  if (users.find(u=>u.email===email)) { showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤', 'error'); return; }

  const newUser = {
    id: 'u_' + Date.now(),
    email, name, role,
    status: 'approved',
    provider: 'admin',
    password: pw,
    creditTotal: credit,
    creditUsed: 0,
    creditPending: 0,
    createdAt: new Date().toISOString()
  };
  users.push(newUser);
  DB.saveUsers(users);
  DB.addLog(`ê´€ë¦¬ìê°€ ê³„ì • ìƒì„±: ${email}`, currentUser.id);
  showToast(`${name} ê³„ì • ìƒì„± ì™„ë£Œ`, 'success');
  closeModal('modal-create-user');
  renderAdminMembers();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderLogs() {
  const logs = DB.getLogs();
  const container = document.getElementById('logs-list');
  if (logs.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“‹</div><p>ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>`;
    return;
  }
  container.innerHTML = logs.map(l => `
    <div style="display:flex;gap:12px;padding:8px 4px;border-bottom:1px solid var(--border);font-size:0.85rem;">
      <div style="color:var(--text-muted);white-space:nowrap;min-width:130px;">${fmtDate(l.ts, true)}</div>
      <div style="color:var(--text-muted);min-width:80px;">${l.userId||'system'}</div>
      <div>${l.msg}</div>
    </div>
  `).join('');
}

function clearLogs() {
  if (!confirm('ëª¨ë“  ë¡œê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  DB.set('logs', []);
  DB.addLog('ë¡œê·¸ ì´ˆê¸°í™”', currentUser.id);
  renderLogs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSV EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function exportCSV() {
  const apps = DB.getApps();
  const rows = [['ì‹ ì²­ID','ì‹ ì²­ì','ì‹ ì²­ì¼','ì´ê¸ˆì•¡','ìƒíƒœ','ì€í–‰','ê³„ì¢Œë²ˆí˜¸','ì˜ˆê¸ˆì£¼','ë¹„ê³ ']];
  apps.forEach(a => {
    rows.push([a.id, a.applicantName, fmtDate(a.createdAt), a.totalAmount, a.status, a.bankName, a.accountNum, a.accountName, a.note||'']);
  });
  const csv = rows.map(r => r.map(c => `"${(c||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'ì‹ ì²­ì·¨í•©_' + new Date().toLocaleDateString() + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  DB.addLog('CSV ë‚´ë³´ë‚´ê¸°', currentUser.id);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showToast(msg, type='') {
  const container = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  t.innerHTML = `<span>${msg}</span>`;
  container.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(20px)'; t.style.transition = '0.3s'; setTimeout(() => t.remove(), 300); }, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function fmt(n) { return Number(n||0).toLocaleString('ko-KR'); }
function fmtDate(iso, withTime=false) {
  if (!iso) return '-';
  const d = new Date(iso);
  const date = d.toLocaleDateString('ko-KR');
  const time = d.toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit'});
  return withTime ? `${date} ${time}` : date;
}
function statusBadge(s) {
  const map = {
    pending: ['ëŒ€ê¸°', 'badge-pending'],
    approved: ['ìŠ¹ì¸', 'badge-approved'],
    rejected: ['ë°˜ë ¤', 'badge-rejected'],
    cancelled: ['ì·¨ì†Œ', 'badge-cancelled'],
    'mod-approved': ['ìˆ˜ì •ìŠ¹ì¸', 'badge-mod-approved'],
  };
  const [label, cls] = map[s] || [s, ''];
  return `<span class="badge ${cls}">${label}</span>`;
}
function catLabel(c) {
  return {boardgame:'ë³´ë“œê²Œì„',escape:'ë°©íƒˆì¶œ',etc:'ê¸°íƒ€'}[c] || c || '-';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.addEventListener('DOMContentLoaded', () => {
  seedData();

  setTimeout(() => {
    document.getElementById('loading-screen').style.opacity = '0';
    setTimeout(() => {
      document.getElementById('loading-screen').style.display = 'none';

      // Check session
      const sessionId = DB.get('session');
      if (sessionId) {
        const user = DB.getUsers().find(u => u.id === sessionId);
        if (user && user.status === 'approved') {
          currentUser = user;
          document.getElementById('login-page').style.display = 'none';
          document.getElementById('app').style.display = 'block';
          initApp();
          return;
        }
      }
      document.getElementById('login-page').style.display = 'flex';
    }, 500);
  }, 1500);
});
</script>
</body>
</html>
